<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestão de Switches de Rede</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif }
    body { background:#f5f7fa; color:#333; padding:20px }
    .container { max-width:1200px; margin:0 auto }
    header { background:linear-gradient(135deg,#2c3e50,#1a2530); color:#fff; padding:20px; border-radius:10px; margin-bottom:30px; box-shadow:0 4px 12px rgba(0,0,0,.1) }
    header .top-actions{ display:flex; gap:10px; justify-content:center; margin-top:12px; flex-wrap:wrap }
    h1 { text-align:center; margin-bottom:6px }
    .subtitle { text-align:center; opacity:.9; font-weight:300 }

    .main-content { display:flex; gap:30px; flex-wrap:wrap }
    .switches-section { background:#fff; padding:25px; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,.05); flex:1; min-width:320px }

    h2 { color:#2c3e50; margin-bottom:20px; padding-bottom:10px; border-bottom:2px solid #eee }
    .h3 { color:#2c3e50; margin:18px 0 10px; font-size:18px; font-weight:800 }
    .muted { color:#7f8c8d; font-size:14px }
    .no-switches, .no-pops { text-align:center; padding:40px; color:#7f8c8d; font-style:italic }

    input, select, button, .btn { font-size:16px }
    .btn { background:#3498db; color:#fff; border:0; padding:12px 16px; border-radius:6px; cursor:pointer; font-weight:600; transition:.25s; display:inline-flex; align-items:center; gap:8px }
    .btn:hover { background:#2980b9 }
    .btn.ghost { background:#ecf0f1; color:#2c3e50 }
    .btn.ghost:hover { background:#d5dbdb }
    .btn.danger { background:#e74c3c }
    .btn.danger:hover { background:#c0392b }
    .btn.small { padding:8px 10px; font-size:14px }

    /* ---------- LISTAGEM AGRUPADA POR ESTADO ---------- */
    .estado-block { margin-bottom:32px }
    .estado-head { display:flex; align-items:center; justify-content:space-between; }
    .estado-badge { background:#eef3f7; border:1px solid #e3e8ee; color:#2c3e50; font-weight:700; padding:4px 10px; border-radius:999px; font-size:12px }

    /* ALTURA INDEPENDENTE POR CARD (flex + wrap) */
    .pop-grid{
      display:flex;
      flex-wrap:wrap;
      gap:20px;
      margin-top:12px;
      align-items:flex-start;
    }
    .pop-card{
      flex: 1 1 320px;
      max-width: 420px;
      background:#f8f9fa; border-radius:8px; overflow:visible;
      box-shadow:0 2px 8px rgba(0,0,0,.1); transition:transform .3s, box-shadow .3s
    }
    .pop-card:hover { transform:translateY(-5px); box-shadow:0 5px 15px rgba(0,0,0,.1) }
    .pop-header { display:flex; align-items:center; justify-content:space-between; padding:16px }
    .pop-title { font-size:18px; font-weight:700; color:#2c3e50 }
    .pop-badge { background:#ecf0f1; padding:4px 10px; border-radius:999px; font-size:12px; color:#2c3e50 }
    .pop-toggle { width:100%; text-align:left; background:#eef3f7; border-top:1px solid #e3e8ee; padding:12px 16px; cursor:pointer; display:flex; align-items:center; justify-content:space-between }
    .pop-toggle span { font-weight:600; color:#2c3e50 }
    .pop-toggle i { transition:transform .2s }
    .pop-toggle.open i { transform:rotate(180deg) }

    .switch-list { display:none; padding:8px 16px 16px 16px; overflow:visible; position:relative }
    .switch-row {
      background:#fff; border:1px solid #eee; border-radius:8px; padding:12px; margin-top:10px;
      display:flex; gap:12px; align-items:center; justify-content:space-between; position:relative; overflow:visible
    }
    .switch-info-wrap { display:flex; flex-direction:column; gap:2px }
    .switch-name { font-weight:700; color:#2c3e50 }
    .switch-meta { font-size:14px; color:#7f8c8d }
    .row-actions { display:flex; gap:8px; align-items:center }

    /* PREVIEW IMAGEM NO HOVER */
    .hover-preview {
      position:absolute; left:50%; bottom: calc(100% + 10px); transform: translate(-50%, 6px) scale(.98);
      width:340px; max-width:90vw; max-height:260px; background:#fff; border:1px solid #e6e9ef; border-radius:10px;
      box-shadow:0 10px 28px rgba(20, 30, 50, .18); padding:10px; opacity:0; pointer-events:none; transition:opacity .15s ease, transform .15s ease; z-index:999
    }
    .switch-row:hover .hover-preview { opacity:1; transform: translate(-50%, 0) scale(1) }
    .hover-preview::before{ content:""; position:absolute; left:50%; bottom:-16px; transform:translateX(-50%); border-width:8px; border-style:solid; border-color:#e6e9ef transparent transparent transparent }
    .hover-preview::after{ content:""; position:absolute; left:50%; bottom:-15px; transform:translateX(-50%); border-width:8px; border-style:solid; border-color:#fff transparent transparent transparent }
    .hover-preview img{ width:100%; height:auto; display:block; border-radius:6px; object-fit:cover; max-height:240px }
    .hover-preview .noimg{ color:#7f8c8d; font-size:14px; text-align:center; padding:18px 6px }

    .modal { position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; padding:20px; z-index:1000 }
    .modal.open { display:flex }
    .modal-content { background:#fff; width:min(900px, 100%); max-height:90vh; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,.25); overflow:auto }
    .modal-header { padding:16px 20px; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between }
    .modal-title { font-size:18px; font-weight:700 }
    .modal-body { padding:20px }
    .modal-footer { padding:16px 20px; border-top:1px solid #eee; display:flex; gap:10px; justify-content:flex-end }
    .close-x { background:transparent; border:0; font-size:20px; cursor:pointer }

    .form-group { margin-bottom:16px }
    label { display:block; margin-bottom:8px; font-weight:600; color:#2c3e50 }
    input, select { width:100%; padding:12px; border:1px solid #ddd; border-radius:5px; transition:border-color .3s }
    input:focus, select:focus { border-color:#3498db; outline:0; box-shadow:0 0 0 2px rgba(52,152,219,.2) }
    .file-input-wrapper { position:relative; overflow:hidden; display:inline-block; width:100% }
    .file-input-wrapper input[type=file] { position:absolute; left:0; top:0; opacity:0; width:100%; height:100%; cursor:pointer }
    .file-input-button { display:block; padding:12px; background:#ecf0f1; border:1px solid #ddd; border-radius:5px; text-align:center; cursor:pointer; transition:background .3s }
    .file-input-button:hover { background:#d5dbdb }

    .hide { display:none !important }
    @media (max-width: 768px) {
      .main-content { flex-direction:column }
      .hover-preview { left:50%; right:auto; bottom:calc(100% + 8px); transform:translate(-50%,0) scale(.98); max-width:95vw }
      .switch-row:hover .hover-preview { transform:translate(-50%,0) scale(1) }
      .hover-preview::before, .hover-preview::after { left:50%; transform:translateX(-50%) }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Gestão de Switches de Rede</h1>
      <p class="subtitle">Agrupado por Estado → POP → Switches</p>
      <div class="top-actions">
        <button class="btn" id="btnNovoCadastro">Novo cadastro</button>
        <button class="btn ghost" id="btnAbrirGerenciarPops">Gerenciar POPs</button>
      </div>
    </header>

    <div class="main-content">
      <section class="switches-section">
        <h2>POPs Cadastrados</h2>
        <div id="estadoContainer">
          <div class="no-pops">Nenhum POP cadastrado ainda. Use “Novo cadastro”.</div>
        </div>
      </section>
    </div>
  </div>

  <!-- SUGESTÕES DE MODELOS -->
  <datalist id="modelosBase">
    <option value="Datacom DM3000"></option>
    <option value="Datacom DM4100"></option>
    <option value="Datacom EDD 2104"></option>
    <option value="Cisco Catalyst 2960"></option>
    <option value="Cisco Catalyst 9200"></option>
    <option value="Huawei S5720"></option>
    <option value="HP/Aruba 2530"></option>
    <option value="MikroTik CRS326"></option>
    <option value="Juniper EX3300"></option>
    <option value="Planet GSW"></option>
  </datalist>

  <!-- MODAL: Cadastro -->
  <div class="modal" id="modalCadastro" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Novo cadastro</div>
        <button class="close-x" data-close="modalCadastro" aria-label="Fechar">&times;</button>
      </div>
      <div class="modal-body">
        <form id="cadastroForm">
          <div class="form-group">
            <label for="tipoCadastro">O que deseja cadastrar?</label>
            <select id="tipoCadastro" required>
              <option value="switch">Switch</option>
              <option value="pop">POP</option>
            </select>
          </div>

          <!-- POP -->
          <div id="camposPOP" class="hide" style="display:none">
            <div class="form-group">
              <label for="popNome">Nome/Descrição do POP</label>
              <input type="text" id="popNome" placeholder="Ex: São Paulo (POP-SP)">
            </div>
            <div class="form-group">
              <label for="popEstado">Estado (UF)</label>
              <select id="popEstado"></select>
            </div>
          </div>

          <!-- SWITCH (ORDEM: POP → Modelo → Nome → IP → Foto) -->
          <div id="camposSW" style="display:block">
            <div class="form-group">
              <label for="pop">POP (Ponto de Presença)</label>
              <select id="pop"></select>
              <div class="muted" style="margin-top:6px">Se o POP não existir, selecione “POP” acima e cadastre.</div>
            </div>
            <div class="form-group">
              <label for="modelo">Modelo</label>
              <input type="text" id="modelo" list="modelosBase" placeholder="Ex: DM3000">
            </div>
            <div class="form-group">
              <label for="nome">Nome do Switch</label>
              <input type="text" id="nome" placeholder="Ex: SWAC01-RCE03">
            </div>
            <div class="form-group">
              <label for="ip">Endereço IP</label>
              <input type="text" id="ip" placeholder="Ex: 192.168.1.100">
            </div>
            <div class="form-group">
              <label for="foto">Foto do Switch</label>
              <div class="file-input-wrapper">
                <div class="file-input-button">Selecionar imagem</div>
                <input type="file" id="foto" accept="image/*">
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn ghost" data-close="modalCadastro">Cancelar</button>
        <button class="btn" id="btnSalvarCadastro">Cadastrar</button>
      </div>
    </div>
  </div>

  <!-- MODAL: Editar Switch -->
  <div class="modal" id="modalEditSwitch" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Editar Switch</div>
        <button class="close-x" data-close="modalEditSwitch" aria-label="Fechar">&times;</button>
      </div>
      <div class="modal-body">
        <form id="formEditSwitch">
          <input type="hidden" id="editSwitchId">
          <div class="form-group">
            <label for="editSwitchNome">Nome do Switch</label>
            <input type="text" id="editSwitchNome">
          </div>
          <div class="form-group">
            <label for="editSwitchIP">Endereço IP</label>
            <input type="text" id="editSwitchIP" placeholder="Ex: 192.168.1.100">
          </div>
          <div class="form-group">
            <label for="editSwitchModelo">Modelo</label>
            <input type="text" id="editSwitchModelo" list="modelosBase" placeholder="Ex: DM4100">
          </div>
          <div class="form-group">
            <label for="editSwitchPop">POP</label>
            <select id="editSwitchPop"></select>
          </div>
          <div class="form-group">
            <label for="editSwitchFoto">Foto do Switch</label>
            <div class="row-actions">
              <div class="file-input-wrapper" style="flex:1">
                <div class="file-input-button">Selecionar imagem</div>
                <input type="file" id="editSwitchFoto" accept="image/*">
              </div>
              <button type="button" class="btn ghost small" id="btnRemoverFoto">Remover imagem</button>
            </div>
            <div class="muted" id="previewInfo" style="margin-top:8px"></div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn ghost" data-close="modalEditSwitch">Cancelar</button>
        <button class="btn" id="btnSalvarEditSwitch">Salvar</button>
      </div>
    </div>
  </div>

  <!-- MODAL: Gerenciar POPs -->
  <div class="modal" id="modalPops" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Gerenciar POPs</div>
        <button class="close-x" data-close="modalPops" aria-label="Fechar">&times;</button>
      </div>
      <div class="modal-body">
        <div class="muted" style="margin-bottom:10px">Renomeie, ajuste o Estado (UF) ou exclua POPs. Ao renomear, o sistema atualiza o <em>slug</em>/id e realoca os Switches automaticamente.</div>
        <table id="tabelaPops">
          <thead>
            <tr>
              <th style="width:34%">Nome/Descrição</th>
              <th style="width:18%">Estado (UF)</th>
              <th style="width:24%">ID (slug)</th>
              <th>Switches</th>
              <th style="width:200px">Ações</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button class="btn ghost" data-close="modalPops">Fechar</button>
        <button class="btn" id="btnSalvarPops">Salvar Alterações</button>
      </div>
    </div>
  </div>

  <script type="module">
    // === Inicialização do Firebase (já com seu firebaseConfig) ===  
    const firebaseConfig = {  
      apiKey: "AIzaSyCGSDjIf8pRP_IE0xqjLii4Qeuc6_bhE50",  
      authDomain: "gestao-switches.firebaseapp.com",  
      databaseURL: "https://gestao-switches-default-rtdb.firebaseio.com",  
      projectId: "gestao-switches",  
      storageBucket: "gestao-switches.firebasestorage.app",  
      messagingSenderId: "499639422553",  
      appId: "1:499639422553:web:b2964704013a95ee666b48",  
      measurementId: "G-EVK2QKJL4Y"  
    };  
  
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";  
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";  
    import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js"; // <-- ADICIONE ESTA LINHA AQUI  
  
    const fbApp = initializeApp(firebaseConfig);  
    const fbAuth = getAuth(fbApp);  
    const fbDb = getDatabase(fbApp);

    // Faça login anônimo (necessário para operações que exigem auth)
    signInAnonymously(fbAuth).catch(err => {
      // se ocorrer erro na autenticação anônima, mostramos no console (não expõe nada)
      console.warn('Erro ao autenticar anon:', err);
    });

    onAuthStateChanged(fbAuth, user => {
      if (user) {
        console.log('Autenticado anonimamente (uid):', user.uid);
      } else {
        console.log('Usuário deslogado');
      }
    });
    // ===============================================================

    const LS_SWITCHES_KEY = 'networkSwitches';
    const LS_POPS_KEY = 'networkPops';

    let switches = [];
    let pops = [];
    let pendingPopEdits = [];

    const byId = (id) => document.getElementById(id);
    function validarIP(ip) {
      const re = /^(25[0-5]|2[0-4]\d|[01]?\d?\d)(\.(25[0-5]|2[0-4]\d|[01]?\d?\d)){3}$/;
      return re.test(ip);
    }
    const slugify = (s) => s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
    const estados = [
      'AC','AL','AP','AM','BA','CE','DF','ES','GO','MA','MT','MS','MG',
      'PA','PB','PR','PE','PI','RJ','RN','RS','RO','RR','SC','SP','SE','TO'
    ];
    const estadoLabel = (uf)=> uf && uf!=='__' ? uf : 'Sem Estado';

    function parseUFFromName(nome){
      const m1 = /\(.*?POP[-\s]?([A-Z]{2})\)/i.exec(nome || '');
      if(m1) return m1[1].toUpperCase();
      const m2 = /\(([A-Z]{2})\)\s*$/.exec(nome || '');
      if(m2) return m2[1].toUpperCase();
      return '__';
    }

    const POPS_PADRAO = [
      { nome:'São Paulo (POP-SP)',   uf:'SP' },
      { nome:'Rio de Janeiro (POP-RJ)', uf:'RJ' },
      { nome:'Belo Horizonte (POP-MG)', uf:'MG' },
      { nome:'Porto Alegre (POP-RS)', uf:'RS' },
      { nome:'Curitiba (POP-PR)',    uf:'PR' },
      { nome:'Salvador (POP-BA)',    uf:'BA' },
      { nome:'Fortaleza (POP-CE)',   uf:'CE' },
      { nome:'Brasília (POP-DF)',    uf:'DF' }
    ].map(n => ({ id: slugify(n.nome), nome: n.nome, estado: n.uf }));

    /* ===== Helpers de IMAGEM & STORAGE ===== */
    async function compressImage(file, {
      maxWidth = 1600,
      maxHeight = 1200,
      mimeType = 'image/webp',
      quality = 0.82
    } = {}) {
      if (!('createImageBitmap' in window)) {
        return await fileToDataURL(file);
      }
      const bitmap = await createImageBitmap(file);
      const { width, height } = bitmap;
      const ratio = Math.min(maxWidth / width, maxHeight / height, 1);
      const targetW = Math.round(width * ratio);
      const targetH = Math.round(height * ratio);

      const canvas = document.createElement('canvas');
      canvas.width = targetW;
      canvas.height = targetH;

      const ctx = canvas.getContext('2d');
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = 'high';
      ctx.drawImage(bitmap, 0, 0, targetW, targetH);

      let outType = mimeType;
      if (!canvas.toDataURL(outType).startsWith('data:image/webp')) {
        outType = 'image/jpeg';
      }
      return canvas.toDataURL(outType, quality);
    }

    function fileToDataURL(file) {
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = e => resolve(e.target.result);
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    }

    function trySaveLocalStorage(key, value) {
      try {
        localStorage.setItem(key, value);
        return true;
      } catch (e) {
        console.warn('Falha ao salvar no localStorage:', e);
        return false;
      }
    }

    async function compressAdaptively(file) {
      const sizeSteps = [
        { w: 2200, h: 1600, q: 0.88 },
        { w: 1800, h: 1350, q: 0.84 },
        { w: 1600, h: 1200, q: 0.82 },
        { w: 1400, h: 1050, q: 0.78 },
        { w: 1200, h: 900,  q: 0.75 },
        { w: 1000, h: 750,  q: 0.72 },
        { w: 900,  h: 675,  q: 0.70 }
      ];
      for (const step of sizeSteps) {
        const dataURL = await compressImage(file, {
          maxWidth: step.w, maxHeight: step.h, quality: step.q
        });
        if (dataURL.length < 4_500_000) return dataURL;
      }
      return await compressImage(file, { maxWidth: 800, maxHeight: 600, quality: 0.68 });
    }
    /* ======================================= */

    /* ====== NOVO: fecha todos os POPs (acordeão) ====== */
    function closeAllPopLists(exceptId = null){
      document.querySelectorAll('.pop-card').forEach(card=>{
        const btn = card.querySelector('[data-toggle-pop]');
        const list = card.querySelector('.switch-list');
        const id = btn?.getAttribute('data-toggle-pop');
        if (id !== exceptId){
          if (btn) { btn.classList.remove('open'); btn.setAttribute('aria-expanded','false'); }
          if (list){ list.style.display = 'none'; }
        }
      });
    }
    /* =================================================== */

    document.addEventListener('DOMContentLoaded', () => {
      byId('btnNovoCadastro').addEventListener('click', openCadastroModal);
      byId('btnAbrirGerenciarPops').addEventListener('click', () => openModalPops());
      document.querySelectorAll('[data-close]').forEach(btn => btn.addEventListener('click', (e)=> closeModal(e.currentTarget.getAttribute('data-close'))));

      byId('btnSalvarCadastro').addEventListener('click', handleCadastroSubmit);
      byId('btnSalvarEditSwitch').addEventListener('click', saveEditSwitch);
      byId('btnRemoverFoto').addEventListener('click', () => { byId('editSwitchFoto').value=''; byId('previewInfo').textContent='Imagem será removida ao salvar.'; byId('previewInfo').dataset.remove='true'; });
      byId('btnSalvarPops').addEventListener('click', applyPopEdits);

      loadPops(); loadSwitches();
      renderUFSelect(byId('popEstado'));
      renderPopOptions();
      renderEstadosComPops();

      /* ====== ATUALIZADO: clique com efeito acordeão ====== */
      byId('estadoContainer').addEventListener('click', (ev) => {
        const toggleBtn = ev.target.closest('[data-toggle-pop]');
        if (toggleBtn) {
          const card = toggleBtn.closest('.pop-card');
          const list = card.querySelector('.switch-list');
          const popId = toggleBtn.getAttribute('data-toggle-pop');
          const isOpen = list.style.display === 'block';

          if (isOpen) {
            toggleBtn.classList.remove('open');
            toggleBtn.setAttribute('aria-expanded','false');
            list.style.display = 'none';
          } else {
            closeAllPopLists(popId);
            toggleBtn.classList.add('open');
            toggleBtn.setAttribute('aria-expanded','true');
            list.style.display = 'block';
          }
          return;
        }
        const swBtn = ev.target.closest('[data-action]');
        if (swBtn) {
          const action = swBtn.dataset.action;
          const swId = Number(swBtn.closest('[data-switch-id]').dataset.switchId);
          if (action === 'edit') openEditSwitch(swId);
          if (action === 'delete') deleteSwitch(swId);
        }
      });
      /* ===================================================== */
    });

    function renderUFSelect(selectEl){
      if(!selectEl) return;
      selectEl.innerHTML = `<option value="__">Sem Estado</option>` + estados.map(uf=>`<option value="${uf}">${uf}</option>`).join('');
    }

    function openModal(id){ const el=byId(id); if(el){ el.classList.add('open'); el.setAttribute('aria-hidden','false'); } }
    function closeModal(id){ const el=byId(id); if(el){ el.classList.remove('open'); el.setAttribute('aria-hidden','true'); } }

    function openCadastroModal() {
      openModal('modalCadastro');
      renderPopOptions();
      const tipoSel = byId('tipoCadastro');
      tipoSel.value = 'switch';
      bindTipoCadastroEvents();
      alternarTipo();
    }
    function bindTipoCadastroEvents() {
      const sel = byId('tipoCadastro');
      const clone = sel.cloneNode(true);
      sel.parentNode.replaceChild(clone, sel);
      clone.addEventListener('change', alternarTipo);
      clone.addEventListener('input',  alternarTipo);
      document.addEventListener('change', (e)=>{ if(e.target && e.target.id==='tipoCadastro') alternarTipo(); }, { once:true });
    }
    function alternarTipo() {
      const tipo = (byId('tipoCadastro')?.value) || 'switch';
      const popBox = byId('camposPOP'); const swBox = byId('camposSW');
      const showPop = (tipo === 'pop');
      popBox.classList.toggle('hide', !showPop); swBox.classList.toggle('hide', showPop);
      popBox.style.display = showPop ? 'block' : 'none';
      swBox.style.display  = showPop ? 'none'  : 'block';
    }

    function migrateOldPops(arr){
      return arr.map(p=>{
        let id = p.id ?? (p.codigo ? String(p.codigo) : null);
        let nome = p.nome ?? (typeof p === 'string' ? p : JSON.stringify(p));
        if(!id) id = slugify(nome);
        let estado = p.estado ?? parseUFFromName(nome);
        if(estado && estado !== '__') estado = estado.toUpperCase();
        return { id, nome, estado: estado || '__' };
      });
    }

    function loadPops(){
      const stored = localStorage.getItem(LS_POPS_KEY);
      if (stored){
        try{ pops = migrateOldPops(JSON.parse(stored)||[]); } catch{ pops=[]; }
      }
      if(!pops || pops.length===0){
        pops=[...POPS_PADRAO]; savePops();
      } else {
        const seen=new Set();
        pops=pops.filter(p=>{
          if(!p.id) p.id=slugify(p.nome||'');
          if(!p.estado) p.estado='__';
          if(seen.has(p.id)) return false; seen.add(p.id); return true;
        });
        savePops();
      }
    }
    function savePops(){ trySaveLocalStorage(LS_POPS_KEY, JSON.stringify(pops)); }

    function loadSwitches(){ const stored=localStorage.getItem(LS_SWITCHES_KEY); if(stored){ try{ switches=JSON.parse(stored)||[]; } catch{ switches=[]; } } }
    function saveSwitches(){
      const ok = trySaveLocalStorage(LS_SWITCHES_KEY, JSON.stringify(switches));
      if (!ok) {
        alert('Não foi possível salvar os dados (limite de armazenamento do navegador atingido). Tente usar uma imagem menor ou deixe sem imagem.');
      }
    }

    function popsByEstado(){
      const groups = {};
      pops.forEach(p=>{
        const uf = p.estado || '__';
        if(!groups[uf]) groups[uf] = [];
        groups[uf].push(p);
      });
      Object.keys(groups).forEach(uf=>{
        groups[uf].sort((a,b)=> a.nome.localeCompare(b.nome, 'pt-BR'));
      });
      return groups;
    }

    function renderEstadosComPops(){
      const wrap = byId('estadoContainer'); if(!wrap) return;
      if(!pops || pops.length===0){ wrap.innerHTML='<div class="no-pops">Nenhum POP cadastrado ainda. Use “Novo cadastro”.</div>'; return; }
      const groups = popsByEstado();
      const ufs = Object.keys(groups).sort((a,b)=>{
        if(a==='__') return 1;
        if(b==='__') return -1;
        return a.localeCompare(b);
      });

      wrap.innerHTML = '';
      ufs.forEach(uf=>{
        const bloco = document.createElement('div');
        bloco.className = 'estado-block';
        const totalSwitchesUF = groups[uf].reduce((acc,p)=> acc + switches.filter(s=>s.pop===p.id).length, 0);
        bloco.innerHTML = `
          <div class="estado-head">
            <div class="h3">${estadoLabel(uf)}</div>
            <div class="estado-badge">${groups[uf].length} POP${groups[uf].length===1?'':'s'} • ${totalSwitchesUF} switch${totalSwitchesUF===1?'':'es'}</div>
          </div>
          <div class="pop-grid"></div>
        `;
        const grid = bloco.querySelector('.pop-grid');

        groups[uf].forEach(pop=>{
          const card = document.createElement('div');
          card.className='pop-card';
          const swDoPop = switches.filter(s=>s.pop===pop.id);
          card.innerHTML = `
            <div class="pop-header">
              <div class="pop-title">${pop.nome}</div>
              <div class="pop-badge">${swDoPop.length} switch${swDoPop.length===1?'':'es'}</div>
            </div>
            <button class="pop-toggle" data-toggle-pop="${pop.id}" aria-expanded="false">
              <span>Ver switches</span><i>▼</i>
            </button>
            <div class="switch-list">
              ${
                swDoPop.length===0
                ? `<div class="no-switches" style="padding:16px">Nenhum switch vinculado a este POP.</div>`
                : swDoPop.map(sw=>`
                    <div class="switch-row" data-switch-id="${sw.id}">
                      <div class="switch-info-wrap">
                        <div class="switch-name">${sw.nome}</div>
                        <div class="switch-meta">IP: ${sw.ip}</div>
                        <div class="switch-meta">Modelo: ${sw.modelo ? sw.modelo : '—'}</div>
                      </div>
                      <div class="row-actions">
                        <button class="btn small" data-action="edit">Editar</button>
                        <button class="btn danger small" data-action="delete">Excluir</button>
                      </div>
                      <div class="hover-preview">
                        ${ sw.foto ? `<img src="${sw.foto}" alt="Foto de ${sw.nome}">` : `<div class="noimg">Sem imagem para este switch</div>` }
                      </div>
                    </div>
                  `).join('')
              }
            </div>`;
          grid.appendChild(card);
        });

        wrap.appendChild(bloco);
      });
    }

    function renderPopOptions(){
      const sel = byId('pop'); if(!sel) return;
      if(!pops || pops.length===0){
        sel.innerHTML = '<option value="">Cadastre um POP</option>';
        return;
      }
      const groups = popsByEstado();
      const ufs = Object.keys(groups).sort((a,b)=>{
        if(a==='__') return 1;
        if(b==='__') return -1;
        return a.localeCompare(b);
      });
      sel.innerHTML = ufs.map(uf=>{
        const options = groups[uf].map(p=>`<option value="${p.id}">${p.nome}</option>`).join('');
        return `<optgroup label="${estadoLabel(uf)}">${options}</optgroup>`;
      }).join('');
    }

    function handleCadastroSubmit(e){ e && e.preventDefault(); const tipo=byId('tipoCadastro').value; if(tipo==='pop') return cadastrarPOP(); return cadastrarSwitch(); }

    function cadastrarPOP(){
      const nome=(byId('popNome').value||'').trim(); if(!nome) return alert('Informe o Nome/Descrição do POP.');
      const uf = (byId('popEstado').value||'__');
      const id=slugify(nome);
      const exists=pops.some(p=>p.id===id||p.nome.toLowerCase()===nome.toLowerCase());
      if(exists) return alert('Já existe um POP com esse nome.');
      pops.push({ id, nome, estado: uf });
      savePops(); renderPopOptions(); renderEstadosComPops();
      resetCadastroForm(); closeModal('modalCadastro'); alert('POP cadastrado.');
    }

    function cadastrarSwitch(){
      const popSel=byId('pop').value; const ip=byId('ip').value.trim(); const nome=byId('nome').value.trim();
      const modelo=(byId('modelo').value||'').trim(); const fotoInput=byId('foto');
      if(!popSel||!ip||!nome) return alert('Preencha POP, IP e Nome do Switch.');
      if(!validarIP(ip)) return alert('IP inválido. Informe um IPv4 válido, ex: 192.168.1.100');
      const sw={ id:Date.now(), pop:popSel, ip, nome, modelo: modelo || null, foto:null };

      if (fotoInput.files && fotoInput.files[0]) {
        const file = fotoInput.files[0];
        compressAdaptively(file).then(dataURL => {
          sw.foto = dataURL;
          finalizarCadastroSwitch(sw);
        }).catch(err => {
          console.warn(err);
          alert('Não foi possível processar a imagem. Vou salvar o switch sem imagem.');
          sw.foto = null;
          finalizarCadastroSwitch(sw);
        });
      } else {
        finalizarCadastroSwitch(sw);
      }
    }

    function finalizarCadastroSwitch(sw){
      switches.push(sw);
      saveSwitches();
      renderPopOptions();
      renderEstadosComPops();
      resetCadastroForm();
      closeModal('modalCadastro');
      alert('Switch cadastrado.');
    }

    function resetCadastroForm(){
      byId('cadastroForm').reset();
      const tipoSel=byId('tipoCadastro'); tipoSel.value='switch'; alternarTipo();
      renderUFSelect(byId('popEstado'));
    }

    function openEditSwitch(id){
      const sw=switches.find(s=>s.id===id); if(!sw) return;
      byId('editSwitchId').value=String(sw.id); byId('editSwitchNome').value=sw.nome; byId('editSwitchIP').value=sw.ip;

      const sel=byId('editSwitchPop');
      sel.innerHTML=pops.map(p=>`<option value="${p.id}">${estadoLabel(p.estado)} — ${p.nome}</option>`).join('');
      sel.value=sw.pop;

      byId('editSwitchModelo').value=sw.modelo||'';
      byId('previewInfo').dataset.remove='false'; byId('previewInfo').textContent=sw.foto?'Imagem atual presente.':'Sem imagem.'; byId('editSwitchFoto').value='';
      openModal('modalEditSwitch');
    }

    function saveEditSwitch(ev){
      ev && ev.preventDefault();
      const id=Number(byId('editSwitchId').value); const nome=byId('editSwitchNome').value.trim();
      const ip=byId('editSwitchIP').value.trim(); const popSel=byId('editSwitchPop').value; const modelo=(byId('editSwitchModelo').value||'').trim();
      const fotoInput=byId('editSwitchFoto'); const removeFlag=byId('previewInfo').dataset.remove==='true';
      if(!nome||!ip||!popSel) return alert('Preencha Nome, IP e POP.');
      if(!validarIP(ip)) return alert('IP inválido.');

      const idx=switches.findIndex(s=>s.id===id); if(idx===-1) return;

      const applyAndClose=(newFoto)=>{
        switches[idx].nome=nome; switches[idx].ip=ip; switches[idx].pop=popSel; switches[idx].modelo=modelo||null;
        if(removeFlag) switches[idx].foto=null;
        if(newFoto!==undefined) switches[idx].foto=newFoto;
        saveSwitches(); renderPopOptions(); renderEstadosComPops(); closeModal('modalEditSwitch'); alert('Switch atualizado.');
      };

      if (fotoInput.files && fotoInput.files[0]) {
        const file = fotoInput.files[0];
        compressAdaptively(file).then(dataURL => {
          applyAndClose(dataURL);
        }).catch(err => {
          console.warn(err);
          alert('Não consegui processar a nova imagem. Vou salvar os demais dados mesmo assim.');
          applyAndClose();
        });
      } else {
        applyAndClose();
      }
    }

    function deleteSwitch(id){
      if(!confirm('Deseja realmente excluir este switch?')) return;
      switches=switches.filter(s=>s.id!==id);
      saveSwitches();
      renderPopOptions();
      renderEstadosComPops();
    }

    function openModalPops(){ buildPopsTable(); openModal('modalPops'); }

    function buildPopsTable(){
      const tbody=byId('tabelaPops').querySelector('tbody'); tbody.innerHTML='';
      pendingPopEdits=pops.map(p=>({ oldId:p.id, id:p.id, nome:p.nome, estado:p.estado||'__', _delete:false }));
      pendingPopEdits.forEach((row,i)=>{
        const vinculados=switches.filter(s=>s.pop===row.id).length;
        const tr=document.createElement('tr'); tr.dataset.index=i;
        const ufSelect = `<select data-field="estado">${['__',...estados].map(uf=>`<option value="${uf}" ${uf===row.estado?'selected':''}>${estadoLabel(uf)}</option>`).join('')}</select>`;
        tr.innerHTML=`
          <td><input type="text" value="${row.nome}" data-field="nome"></td>
          <td>${ufSelect}</td>
          <td><input type="text" value="${row.id}" data-field="id" disabled></td>
          <td>${vinculados}</td>
          <td class="row-actions">
            <button class="btn small" data-act="renomear">Gerar ID</button>
            <button class="btn danger small" data-act="excluir">Excluir</button>
          </td>`;
        tbody.appendChild(tr);
      });
      tbody.onclick=(ev)=>{
        const tr=ev.target.closest('tr'); if(!tr) return; const idx=Number(tr.dataset.index);
        if(ev.target.matches('[data-act="renomear"]')){
          const nomeInput=tr.querySelector('input[data-field="nome"]');
          const idInput=tr.querySelector('input[data-field="id"]');
          const novoId=slugify(nomeInput.value.trim());
          idInput.value=novoId; pendingPopEdits[idx].id=novoId; pendingPopEdits[idx].nome=nomeInput.value.trim();
        }
        if(ev.target.matches('[data-act="excluir"]')){
          const idAtual=pendingPopEdits[idx].id;
          const vinculados=switches.filter(s=>s.pop===idAtual).length;
          if(vinculados>0) return alert('Não é possível excluir: existem switches vinculados a este POP.');
          if(!confirm('Confirmar exclusão deste POP?')) return;
          pendingPopEdits[idx]._delete=true; tr.style.opacity=.5;
        }
      };
      tbody.oninput=(ev)=>{
        const tr=ev.target.closest('tr'); if(!tr) return; const idx=Number(tr.dataset.index);
        if(ev.target.dataset.field==='nome') pendingPopEdits[idx].nome=ev.target.value;
        if(ev.target.dataset.field==='estado') pendingPopEdits[idx].estado=ev.target.value;
      };
      tbody.onchange = tbody.oninput;
    }

    function applyPopEdits(){
      const effective=pendingPopEdits.filter(r=>!r._delete);
      const ids=effective.map(r=>r.id);
      const nomes=effective.map(r=>r.nome.trim().toLowerCase());
      if(ids.length!==new Set(ids).size) return alert('IDs (slug) duplicados após edição. Ajuste os nomes/IDs.');
      if(nomes.length!==new Set(nomes).size) return alert('Nomes duplicados após edição. Ajuste os nomes.');

      pendingPopEdits.filter(r=>r._delete).forEach(rem=>{ pops=pops.filter(p=>p.id!==rem.oldId); });

      pendingPopEdits.filter(r=>!r._delete).forEach(edit=>{
        const pIdx=pops.findIndex(p=>p.id===edit.oldId); if(pIdx===-1) return;
        const idChanged=edit.oldId!==edit.id;
        pops[pIdx].id=edit.id; pops[pIdx].nome=edit.nome; pops[pIdx].estado=edit.estado || '__';
        if(idChanged){ switches.forEach(s=>{ if(s.pop===edit.oldId) s.pop=edit.id; }); }
      });

      savePops(); saveSwitches(); renderPopOptions(); renderEstadosComPops(); closeModal('modalPops'); alert('POPs atualizados.');
    }
  </script>
</body>
</html>
