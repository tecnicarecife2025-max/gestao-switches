<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestão de Switches de Rede</title>
  <style>
    :root{
      --sbw: 260px;           /* largura sidebar aberta */
      --sbw-collapsed: 52px;  /* largura sidebar colapsada */
    }
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif }
    body { background:#f5f7fa; color:#333 }
    .container { max-width:1200px; margin:0 auto; padding:20px }

    /* ===== Sidebar ===== */
    .sidebar {
      position: fixed; left:0; top:0; bottom:0; width:var(--sbw);
      background:linear-gradient(180deg,#1a2530,#111923);
      color:#e5e7eb; box-shadow:2px 0 12px rgba(0,0,0,.15); z-index:1100;
      transition: width .25s ease, transform .25s ease;
      will-change: width, transform;
      overflow-x:hidden;
      display:flex; flex-direction:column;
    }

    /* Cabeçalho da sidebar */
    .brand{
      display:flex; align-items:center; gap:10px; justify-content:space-between;
      padding:12px; border-bottom:1px solid rgba(255,255,255,.06); flex-shrink:0;
      min-height:56px;
    }
    .brand-left{ display:flex; align-items:center; gap:10px; min-width:0 }
    .logo {
      width:36px; height:36px; border-radius:10px; background:#2b3b4a;
      display:grid; place-items:center; font-weight:800; color:#a7c7ff;
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.08)
    }
    .title { font-size:14px; line-height:1.15; white-space:nowrap; transition:opacity .2s ease }
    .title b{ display:block; font-size:15px; color:#fff }

    /* Botão de colapsar/expandir */
    .collapse-btn{
      background:#ffffff1a; border:1px solid #ffffff24; color:#fff;
      padding:8px 10px; border-radius:8px; cursor:pointer; transition:.2s;
      display:inline-flex; align-items:center; gap:8px; white-space:nowrap; flex-shrink:0;
    }
    .collapse-btn:hover{ background:#ffffff2d }
    .collapse-btn svg{ width:18px; height:18px; transition:transform .25s ease }

    /* Menu */
    .menu{ padding:10px; overflow:auto; flex:1 }
    .menu h4{
      font-size:12px; color:#9fb0c2; letter-spacing:.06em; text-transform:uppercase;
      margin:10px 10px 6px; white-space:nowrap; transition:opacity .2s ease
    }
    .menu .item{
      display:flex; align-items:center; gap:10px;
      padding:12px 14px; margin:6px 6px; border-radius:10px; cursor:pointer;
      color:#e5e7eb; user-select:none; transition:.18s background, .18s transform;
      position:relative; white-space:nowrap; line-height:1;
    }
    .menu .item:hover{ background:rgba(255,255,255,.09) }
    .menu .item:active{ transform:translateY(1px) }
    .menu .item .icon{
      width:22px; height:22px; display:grid; place-items:center; flex:0 0 22px; opacity:.95;
    }
    .menu .item .icon svg{ width:20px; height:20px; }
    .menu .item span{ transition:opacity .2s ease, transform .2s ease }

    /* ===== Layout principal deslocado pela sidebar ===== */
    .with-sidebar { margin-left:var(--sbw); transition: margin-left .25s ease }

    /* ====== ESTADO COLAPSADO (desktop) ====== */
    body.sidebar-collapsed .sidebar{ width:var(--sbw-collapsed) }
    body.sidebar-collapsed .with-sidebar{ margin-left:var(--sbw-collapsed) }

    /* Oculta textos/ajusta header */
    body.sidebar-collapsed .title{ opacity:0; pointer-events:none }
    body.sidebar-collapsed .brand{ justify-content:center; gap:0px; }

    /* Ocultar o logo quando colapsado */
    body.sidebar-collapsed .logo{ display:none; }
    body.sidebar-collapsed .brand-left{ width:0; padding:0; margin:0; overflow:hidden; }

    body.sidebar-collapsed .collapse-btn span{ display:none }
    body.sidebar-collapsed .collapse-btn{ padding:8px; }
    body.sidebar-collapsed .collapse-btn svg { transform: rotate(180deg); }

    /* Rail de ícones */
    body.sidebar-collapsed .menu{ padding:8px 6px }
    body.sidebar-collapsed .menu h4{ height:0; margin:0; padding:0; opacity:0; overflow:hidden; }
    body.sidebar-collapsed .menu .item{
      justify-content:center; gap:0; padding:10px; margin:4px 6px; border-radius:12px;
    }
    body.sidebar-collapsed .menu .item .icon{ width:auto; height:auto; }
    body.sidebar-collapsed .menu .item span{ opacity:0; pointer-events:none; transform:translateX(-6px); }

    /* Tooltip quando colapsado */
    body.sidebar-collapsed .menu .item[data-label]:hover::after{
      content:attr(data-label);
      position:absolute; left:calc(100% + 8px); top:50%; transform:translateY(-50%);
      background:#111923; color:#e5e7eb; border:1px solid #ffffff24;
      padding:6px 10px; border-radius:8px; white-space:nowrap; box-shadow:0 6px 20px rgba(0,0,0,.25);
      z-index:1500;
    }

    /* ===== Comportamento mobile: slide in/out ===== */
    @media (max-width: 900px){
      .sidebar { transform:translateX(-100%) }
      body.sidebar-open .sidebar { transform:none }
      .with-sidebar { margin-left:0 }
      .sidebar-overlay {
        content:""; position:fixed; inset:0; background:rgba(0,0,0,.35);
        display:none; z-index:1000;
      }
      body.sidebar-open .sidebar-overlay { display:block }

      .edge-hitbox {
        position: fixed; left:0; top:0; bottom:0; width:18px;
        z-index:900; background:transparent;
      }
    }
    @media (min-width: 901px){
      .edge-hitbox{ display:none }
    }

    /* ===== Header / Sections ===== */
    header {
      background:linear-gradient(135deg,#2c3e50,#1a2530); color:#fff; padding:20px;
      border-radius:10px; margin-bottom:30px; box-shadow:0 4px 12px rgba(0,0,0,.1)
    }
    .header-row{ text-align:center; display:block }
    h1 { margin-bottom:6px }
    .subtitle { opacity:.9; font-weight:300; white-space:nowrap }

    .btn { background:#3498db; color:#fff; border:0; padding:12px 16px; border-radius:6px; cursor:pointer; font-weight:600; transition:.25s; display:inline-flex; align-items:center; gap:8px }
    .btn:hover { background:#2980b9 }
    .btn.ghost { background:#ecf0f1; color:#2c3e50 }
    .btn.ghost:hover { background:#d5dbdb }
    .btn.danger { background:#e74c3c }
    .btn.danger:hover { background:#c0392b }
    .btn.small { padding:8px 10px; font-size:14px }

    .main-content { display:flex; gap:30px; flex-wrap:wrap }
    .switches-section { background:#fff; padding:25px; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,.05); flex:1; min-width:320px }

    h2 { color:#2c3e50; margin-bottom:20px; padding-bottom:10px; border-bottom:2px solid #eee }
    .h3 { color:#2c3e50; margin:18px 0 10px; font-size:18px; font-weight:800 }
    .muted { color:#7f8c8d; font-size:14px }
    .no-switches, .no-pops { text-align:center; padding:40px; color:#7f8c8d; font-style:italic }

    /* ---------- LISTAGEM AGRUPADA POR ESTADO ---------- */
    .estado-block { margin-bottom:32px }
    .estado-head { display:flex; align-items:center; justify-content:space-between; }
    .estado-badge { background:#eef3f7; border:1px solid #e3e8ee; color:#2c3e50; font-weight:700; padding:4px 10px; border-radius:999px; font-size:12px }

    .pop-grid{
      display:flex; flex-wrap:wrap; gap:20px; margin-top:12px; align-items:flex-start;
    }
    .pop-card{
      flex: 1 1 320px; max-width: 420px; background:#f8f9fa; border-radius:8px; overflow:visible;
      box-shadow:0 2px 8px rgba(0,0,0,.1); transition:transform .3s, box-shadow .3s
    }
    .pop-card:hover { transform:translateY(-5px); box-shadow:0 5px 15px rgba(0,0,0,.1) }
    .pop-header { display:flex; align-items:center; justify-content:space-between; padding:16px }
    .pop-title { font-size:18px; font-weight:700; color:#2c3e50 }
    .pop-badge { background:#ecf0f1; padding:4px 10px; border-radius:999px; font-size:12px; color:#2c3e50 }
    .pop-toggle { width:100%; text-align:left; background:#eef3f7; border-top:1px solid #e3e8ee; padding:12px 16px; cursor:pointer; display:flex; align-items:center; justify-content:space-between }
    .pop-toggle span { font-weight:600; color:#2c3e50 }
    .pop-toggle i { transition:transform .2s }
    .pop-toggle.open i { transform:rotate(180deg) }

    .switch-list { display:none; padding:8px 16px 16px 16px; overflow:visible; position:relative }
    .switch-row {
      background:#fff; border:1px solid #eee; border-radius:8px; padding:12px; margem-top:10px;
      display:flex; gap:12px; align-items:center; justify-content:space-between; position:relative; overflow:visible
    }
    .switch-info-wrap { display:flex; flex-direction:column; gap:2px }
    .switch-name { font-weight:700; color:#2c3e50 }
    .switch-meta { font-size:14px; color:#7f8c8d }
    .row-actions { display:flex; gap:8px; align-items:center }

    /* PREVIEW IMAGEM NO HOVER */
    .hover-preview {
      position:absolute; left:50%; bottom: calc(100% + 10px); transform: translate(-50%, 6px) scale(.98);
      width:340px; max-width:90vw; max-height:260px; background:#fff; border:1px solid #e6e9ef; border-radius:10px;
      box-shadow:0 10px 28px rgba(20, 30, 50, .18); padding:10px; opacity:0; pointer-events:none; transition:opacity .15s ease, transform .15s ease; z-index:999
    }
    .switch-row:hover .hover-preview { opacity:1; transform: translate(-50%, 0) scale(1) }
    .hover-preview::before{ content:""; position:absolute; left:50%; bottom:-16px; transform:translateX(-50%); border-width:8px; border-style:solid; border-color:#e6e9ef transparent transparent transparent }
    .hover-preview::after{ content:""; position:absolute; left:50%; bottom:-15px; transform:translateX(-50%); border-width:8px; border-style:solid; border-color:#fff transparent transparent transparent }
    .hover-preview img{ width:100%; height:auto; display:block; border-radius:6px; object-fit:cover; max-height:240px }
    .hover-preview .noimg{ color:#7f8c8d; font-size:14px; text-align:center; padding:18px 6px }

    .modal { position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; padding:20px; z-index:1200 }
    .modal.open { display:flex }
    .modal-content { background:#fff; width:min(900px, 100%); max-height:90vh; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,.25); overflow:auto }
    .modal-header { padding:16px 20px; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between }
    .modal-title { font-size:18px; font-weight:700 }
    .modal-body { padding:20px }
    .modal-footer { padding:16px 20px; border-top:1px solid #eee; display:flex; gap:10px; justify-content:flex-end }
    .close-x { background:transparent; border:0; font-size:20px; cursor:pointer }

    .form-group { margin-bottom:16px }
    label { display:block; margin-bottom:8px; font-weight:600; color:#2c3e50 }
    input, select { width:100%; padding:12px; border:1px solid #ddd; border-radius:5px; transition:border-color .3s }
    input:focus, select:focus { border-color:#3498db; outline:0; box-shadow:0 0 0 2px rgba(52,152,219,.2) }
    .file-input-wrapper { position:relative; overflow:hidden; display:inline-block; width:100% }
    .file-input-wrapper input[type=file] { position:absolute; left:0; top:0; opacity:0; width:100%; height:100%; cursor:pointer }
    .file-input-button { display:block; padding:12px; background:#ecf0f1; border:1px solid #ddd; border-radius:5px; text-align:center; cursor:pointer; transition:background .3s }
    .file-input-button:hover { background:#d5dbdb }

    .hide { display:none !important }

    /* ===== Loading barra / spinner ===== */
    .loading-wrap { display:flex; flex-direction:column; align-items:center; justify-content:center; padding:28px; min-height:140px; }
    .progress { width:100%; max-width:420px; height:10px; background:#e8eef6; border-radius:999px; overflow:hidden; position:relative; }
    .progress .indeterminate {
      position:absolute; left:-40%; top:0; bottom:0; width:40%; background:linear-gradient(90deg,#3498db,#6fb3ff);
      animation: indeterminate 1.2s infinite linear;
    }
    @keyframes indeterminate {
      0% { left:-40%; width:40%; }
      50% { left:30%; width:30%; }
      100% { left:100%; width:40%; }
    }

    /* Confirm/Alert modal adjustments */
    #confirmModal .modal-body { padding:18px 20px; color:#333; }
    #confirmModal .modal-footer { padding:12px 20px; }

    @media (max-width: 768px) {
      .main-content { flex-direction:column }
      .hover-preview { left:50%; right:auto; bottom:calc(100% + 8px); transform:translate(-50%,0) scale(.98); max-width:95vw }
      .switch-row:hover .hover-preview { transform:translate(-50%,0) scale(1) }
      .hover-preview::before, .hover-preview::after { left:50%; transform:translateX(-50%) }
    }
  </style>
</head>
<body>
  <!-- Overlay para mobile quando sidebar aberta -->
  <div class="sidebar-overlay" onclick="document.body.classList.remove('sidebar-open')"></div>
  <!-- Hitbox invisível no mobile para abrir a sidebar -->
  <div class="edge-hitbox" id="edgeHitbox" aria-hidden="true"></div>

  <!-- ===== Sidebar ===== -->
  <aside class="sidebar" aria-label="Menu lateral">
    <div class="brand">
      <div class="brand-left">
        <div class="logo">GR</div>
        <div class="title">
          <b>MENU</b>
        </div>
      </div>
      <button class="collapse-btn" id="btnCollapse" aria-expanded="true" title="Ocultar menu">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
             stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
      </button>
    </div>

    <nav class="menu">
      <h4>Ações</h4>
      <div class="item" id="menuNovoCadastro" data-label="Novo cadastro" role="button" tabindex="0">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
               stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 5v14M5 12h14"></path>
          </svg>
        </span>
        <span>Novo cadastro</span>
      </div>

      <div class="item" id="menuGerenciarPops" data-label="Gerenciar POPs" role="button" tabindex="0">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
               stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"></path>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.07a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.07a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06A2 2 0 1 1 7.02 3.2l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.07a1.65 1.65 0 0 0 1 1.51h.1a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c0 .66.39 1.26 1 1.51.16.07.33.11.51.11H21a2 2 0 1 1 0 4h-.07c-.18 0-.35.04-.51.11-.61.25-1 .85-1 1.51z"></path>
          </svg>
        </span>
        <span>Gerenciar POPs</span>
      </div>
    </nav>
  </aside>

  <!-- ===== Conteúdo ===== -->
  <div class="with-sidebar">
    <div class="container">
      <header>
        <div class="header-row">
          <h1>Gestão de Switches de Rede</h1>
          <p class="subtitle">Todos → Switches de POPs</p>
        </div>
      </header>

      <div class="main-content">
        <section class="switches-section">
          <h2>POPs Cadastrados</h2>
          <div id="estadoContainer">
            <!-- agora mostramos um loading até os dados chegarem -->
            <div id="estadoLoading" class="loading-wrap" role="status" aria-live="polite" aria-busy="true">
              <div class="progress" aria-hidden="true"><div class="indeterminate"></div></div>
              <div class="muted" style="text-align:center;margin-top:12px">Carregando POPs…</div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <!-- Confirm/Alert modal reutilizável -->
  <div class="modal" id="confirmModal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="confirmModalTitle">
    <div class="modal-content" style="max-width:600px">
      <div class="modal-header">
        <div class="modal-title" id="confirmModalTitle">Confirmar</div>
        <button class="close-x" data-close="confirmModal" aria-label="Fechar">&times;</button>
      </div>
      <div class="modal-body">
        <p id="confirmModalMessage" style="margin:0; color:#333; line-height:1.4"></p>
      </div>
      <div class="modal-footer">
        <button class="btn ghost" id="confirmCancelBtn">Cancelar</button>
        <button class="btn danger" id="confirmOkBtn">Remover</button>
      </div>
    </div>
  </div>

  <!-- SUGESTÕES DE MODELOS -->
  <datalist id="modelosBase">
    <option value="Datacom DM3000"></option>
    <option value="Datacom DM4100"></option>
    <option value="Datacom EDD 2104"></option>
    <option value="Cisco Catalyst 2960"></option>
    <option value="Cisco Catalyst 9200"></option>
    <option value="Huawei S5720"></option>
    <option value="HP/Aruba 2530"></option>
    <option value="MikroTik CRS326"></option>
    <option value="Juniper EX3300"></option>
    <option value="Planet GSW"></option>
  </datalist>

  <!-- MODAIS (cadastro/edição/pops) -->
  <div class="modal" id="modalCadastro" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Novo cadastro</div>
        <button class="close-x" data-close="modalCadastro" aria-label="Fechar">&times;</button>
      </div>
      <div class="modal-body">
        <form id="cadastroForm">
          <div class="form-group">
            <label for="tipoCadastro">O que deseja cadastrar?</label>
            <select id="tipoCadastro" required>
              <option value="switch">Switch</option>
              <option value="pop">POP</option>
            </select>
          </div>

          <div id="camposPOP" class="hide" style="display:none">
            <div class="form-group">
              <label for="popNome">Nome/Descrição do POP</label>
              <input type="text" id="popNome" placeholder="Ex: São Paulo (POP-SP)">
            </div>
            <div class="form-group">
              <label for="popEstado">Estado (UF)</label>
              <select id="popEstado"></select>
            </div>
          </div>

          <div id="camposSW" style="display:block">
            <div class="form-group">
              <label for="pop">POP (Ponto de Presença)</label>
              <select id="pop"></select>
              <div class="muted" style="margin-top:6px">Se o POP não existir, selecione “POP” acima e cadastre.</div>
            </div>
            <div class="form-group">
              <label for="modelo">Modelo</label>
              <input type="text" id="modelo" list="modelosBase" placeholder="Ex: DM3000">
            </div>
            <div class="form-group">
              <label for="nome">Nome do Switch</label>
              <input type="text" id="nome" placeholder="Ex: SWAC01-RCE03">
            </div>
            <div class="form-group">
              <label for="ip">Endereço IP</label>
              <input type="text" id="ip" placeholder="Ex: 192.168.1.100">
            </div>
            <div class="form-group">
              <label for="foto">Foto do Switch</label>
              <div class="file-input-wrapper">
                <div class="file-input-button">Selecionar imagem</div>
                <input type="file" id="foto" accept="image/*">
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn ghost" data-close="modalCadastro">Cancelar</button>
        <button class="btn" id="btnSalvarCadastro">Cadastrar</button>
      </div>
    </div>
  </div>

  <div class="modal" id="modalEditSwitch" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Editar Switch</div>
        <button class="close-x" data-close="modalEditSwitch" aria-label="Fechar">&times;</button>
      </div>
      <div class="modal-body">
        <form id="formEditSwitch">
          <input type="hidden" id="editSwitchId">
          <div class="form-group">
            <label for="editSwitchNome">Nome do Switch</label>
            <input type="text" id="editSwitchNome">
          </div>
          <div class="form-group">
            <label for="editSwitchIP">Endereço IP</label>
            <input type="text" id="editSwitchIP" placeholder="Ex: 192.168.1.100">
          </div>
          <div class="form-group">
            <label for="editSwitchModelo">Modelo</label>
            <input type="text" id="editSwitchModelo" list="modelosBase" placeholder="Ex: DM4100">
          </div>
          <div class="form-group">
            <label for="editSwitchPop">POP</label>
            <select id="editSwitchPop"></select>
          </div>
          <div class="form-group">
            <label for="editSwitchFoto">Foto do Switch</label>
            <div class="row-actions">
              <div class="file-input-wrapper" style="flex:1">
                <div class="file-input-button">Selecionar imagem</div>
                <input type="file" id="editSwitchFoto" accept="image/*">
              </div>
              <button type="button" class="btn ghost small" id="btnRemoverFoto">Remover imagem</button>
            </div>
            <div class="muted" id="previewInfo" style="margin-top:8px"></div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn ghost" data-close="modalEditSwitch">Cancelar</button>
        <button class="btn" id="btnSalvarEditSwitch">Salvar</button>
      </div>
    </div>
  </div>

  <div class="modal" id="modalPops" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Gerenciar POPs</div>
        <button class="close-x" data-close="modalPops" aria-label="Fechar">&times;</button>
      </div>
      <div class="modal-body">
        <div class="muted" style="margin-bottom:10px">Renomeie, ajuste o Estado (UF) ou exclua POPs. Ao renomear, o sistema atualiza o <em>slug</em>/id e realoca os Switches automaticamente.</div>
        <table id="tabelaPops">
          <thead>
            <tr>
              <th style="width:34%">Nome/Descrição</th>
              <th style="width:18%">Estado (UF)</th>
              <th style="width:24%">ID (slug)</th>
              <th>Switches</th>
              <th style="width:200px">Ações</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button class="btn ghost" data-close="modalPops">Fechar</button>
        <button class="btn" id="btnSalvarPops">Salvar Alterações</button>
      </div>
    </div>
  </div>

  <script type="module">
    /* ========= Firebase ========= */
    const firebaseConfig = {
      apiKey: "AIzaSyCGSDjIf8pRP_IE0xqjLii4Qeuc6_bhE50",
      authDomain: "gestao-switches.firebaseapp.com",
      databaseURL: "https://gestao-switches-default-rtdb.firebaseio.com",
      projectId: "gestao-switches",
      storageBucket: "gestao-switches.firebasestorage.app",
      messagingSenderId: "499639422553",
      appId: "1:499639422553:web:b2964704013a95ee666b48",
      measurementId: "G-EVK2QKJL4Y"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    const fbApp = initializeApp(firebaseConfig);
    const fbAuth = getAuth(fbApp);
    const fbDb = getDatabase(fbApp);

    signInAnonymously(fbAuth).catch(err => console.warn('[FB] Erro ao autenticar anon:', err));
    onAuthStateChanged(fbAuth, user => {
      if (user) { loadPops(); loadSwitches(); }
    });

    /* ========= Estado / Utils ========= */
    const LS_SWITCHES_KEY = 'networkSwitches'; // mantidos para fallback, mas não usados para leitura
    const LS_POPS_KEY = 'networkPops';
    const LS_SIDEBAR_STATE = 'sidebarCollapsed';

    let switches = [];
    let pops = [];
    let pendingPopEdits = [];

    let popsLoaded = false;
    let switchesLoaded = false;
    let loadFallbackTimer = null;

    const byId = (id) => document.getElementById(id);
    const isMobile = () => window.matchMedia('(max-width: 900px)').matches;

    function validarIP(ip) {
      const re = /^(25[0-5]|2[0-4]\d|[01]?\d?\d)(\.(25[0-5]|2[0-4]\d|[01]?\d?\d)){3}$/;
      return re.test(ip);
    }
    const slugify = (s) => s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
    const estados = [
      'AC','AL','AP','AM','BA','CE','DF','ES','GO','MA','MT','MS','MG',
      'PA','PB','PR','PE','PI','RJ','RN','RS','RO','RR','SC','SP','SE','TO'
    ];
    const estadoLabel = (uf)=> uf && uf!=='__' ? uf : 'Sem Estado';

    function parseUFFromName(nome){
      const m1 = /\(.*?POP[-\s]?([A-Z]{2})\)/i.exec(nome || ''); if(m1) return m1[1].toUpperCase();
      const m2 = /\(([A-Z]{2})\)\s*$/.exec(nome || ''); if(m2) return m2[1].toUpperCase();
      return '__';
    }

    const POPS_PADRAO = [
      { nome:'São Paulo (POP-SP)',   uf:'SP' },
      { nome:'Rio de Janeiro (POP-RJ)', uf:'RJ' },
      { nome:'Belo Horizonte (POP-MG)', uf:'MG' },
      { nome:'Porto Alegre (POP-RS)', uf:'RS' },
      { nome:'Curitiba (POP-PR)',    uf:'PR' },
      { nome:'Salvador (POP-BA)',    uf:'BA' },
      { nome:'Fortaleza (POP-CE)',   uf:'CE' },
      { nome:'Brasília (POP-DF)',    uf:'DF' }
    ].map(n => ({ id: slugify(n.nome), nome: n.nome, estado: n.uf }));

    /* ===== Helpers de imagem ===== */
    async function compressImage(file, {
      maxWidth = 1600, maxHeight = 1200, mimeType = 'image/webp', quality = 0.82
    } = {}) {
      if (!('createImageBitmap' in window)) return await fileToDataURL(file);
      const bitmap = await createImageBitmap(file);
      const { width, height } = bitmap;
      const ratio = Math.min(maxWidth / width, maxHeight / height, 1);
      const targetW = Math.round(width * ratio);
      const targetH = Math.round(height * ratio);
      const canvas = document.createElement('canvas');
      canvas.width = targetW; canvas.height = targetH;
      const ctx = canvas.getContext('2d');
      ctx.imageSmoothingEnabled = true; ctx.imageSmoothingQuality = 'high';
      ctx.drawImage(bitmap, 0, 0, targetW, targetH);
      let outType = mimeType;
      if (!canvas.toDataURL(outType).startsWith('data:image/webp')) outType = 'image/jpeg';
      return canvas.toDataURL(outType, quality);
    }
    function fileToDataURL(file) {
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = e => resolve(e.target.result);
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    }
    async function compressAdaptively(file) {
      const sizeSteps = [
        { w: 2200, h: 1600, q: 0.88 }, { w: 1800, h: 1350, q: 0.84 },
        { w: 1600, h: 1200, q: 0.82 }, { w: 1400, h: 1050, q: 0.78 },
        { w: 1200, h: 900,  q: 0.75 }, { w: 1000, h: 750,  q: 0.72 },
        { w: 900,  h: 675,  q: 0.70 }
      ];
      for (const step of sizeSteps) {
        const dataURL = await compressImage(file, { maxWidth: step.w, maxHeight: step.h, quality: step.q });
        if (dataURL.length < 4_500_000) return dataURL;
      }
      return await compressImage(file, { maxWidth: 800, maxHeight: 600, quality: 0.68 });
    }

    /* ====== Acordeão POPs ====== */
    function closeAllPopLists(exceptId = null){
      document.querySelectorAll('.pop-card').forEach(card=>{
        const btn = card.querySelector('[data-toggle-pop]');
        const list = card.querySelector('.switch-list');
        const id = btn?.getAttribute('data-toggle-pop');
        if (id !== exceptId){
          if (btn) { btn.classList.remove('open'); btn.setAttribute('aria-expanded','false'); }
          if (list){ list.style.display = 'none'; }
        }
      });
    }

    /* ====== Sidebar: colapso, auto-hide e mobile ====== */
    function setCollapsed(collapsed){
      document.body.classList.toggle('sidebar-collapsed', collapsed);
      try { localStorage.setItem(LS_SIDEBAR_STATE, collapsed ? '1' : '0'); } catch {}
      const btn = byId('btnCollapse');
      if (btn){
        btn.setAttribute('aria-expanded', String(!collapsed));
        btn.title = collapsed ? 'Mostrar menu' : 'Ocultar menu';
      }
    }
    function isSidebarOpen(){
      return isMobile()
        ? document.body.classList.contains('sidebar-open')
        : !document.body.classList.contains('sidebar-collapsed');
    }
    function closeSidebar(){
      if (isMobile()) document.body.classList.remove('sidebar-open');
      else setCollapsed(true);
    }

    let autoHideTimer = null;
    let isSidebarHovered = false;

    function scheduleAutoHide(){
      clearTimeout(autoHideTimer);
      if (!isSidebarOpen()) return;
      autoHideTimer = setTimeout(()=>{
        if (!isSidebarHovered && isSidebarOpen()){
          closeSidebar();
        }
      }, 5000); // 5 segundos
    }
    function cancelAutoHide(){ clearTimeout(autoHideTimer); }

    /* ========= Firebase: Pops & Switches ========= */
    function loadPops(){
      const dbRef = ref(fbDb, 'pops');
      onValue(dbRef, (snapshot) => {
        const data = snapshot.val();
        pops = data ? Object.values(data) : [];
        if (!pops || pops.length === 0) { pops = [...POPS_PADRAO]; savePops(); }
        // preenche select de pops imediatamente (útil no formulário)
        renderPopOptions();
        popsLoaded = true;
        renderWhenReady();
      }, (error) => {
        console.error("Erro ao carregar POPs:", error);
        popsLoaded = true; // evitar loading infinito — trataremos no renderWhenReady
        renderWhenReady();
      });
    }

    function savePops(){
      const dbRef = ref(fbDb, 'pops');
      const popsObj = {}; pops.forEach(pop => { popsObj[pop.id] = pop; });
      set(dbRef, popsObj).catch(err => { console.error("Erro ao salvar POPs:", err); showAlert({ title:'Erro', message:'Falha ao salvar POPs.' }); });
    }

    function loadSwitches(){
      const dbRef = ref(fbDb, 'switches');
      onValue(dbRef, (snapshot) => {
        const data = snapshot.val();
        switches = data ? Object.values(data) : [];
        switchesLoaded = true;
        renderWhenReady();
      }, (error) => {
        console.error("Erro ao carregar switches:", error);
        switchesLoaded = true;
        renderWhenReady();
      });
    }

    function saveSwitches(){
      const dbRef = ref(fbDb, 'switches');
      const switchesObj = {}; switches.forEach(sw => { switchesObj[sw.id] = sw; });
      set(dbRef, switchesObj).catch(err => { console.error("Erro ao salvar switches:", err); showAlert({ title:'Erro', message:'Falha ao salvar switches.' }); });
    }

    /* ========= Confirm/Alert helpers (modal) ========= */
    function _openModalById(id) {
      const el = document.getElementById(id);
      if (!el) return;
      el.classList.add('open');
      el.setAttribute('aria-hidden', 'false');
    }
    function _closeModalById(id) {
      const el = document.getElementById(id);
      if (!el) return;
      el.classList.remove('open');
      el.setAttribute('aria-hidden', 'true');
    }

    // Confirm modal (retorna Promise<boolean>) - agora move o modal para o final do body e garante z-index alto
    function showConfirm({ title = 'Confirmar', message = '', okLabel = 'Confirmar', cancelLabel = 'Cancelar', okIsDanger = false } = {}) {
      return new Promise(resolve => {
        const modal = byId('confirmModal');
        if (!modal) {
          resolve(window.confirm(message));
          return;
        }

        // Trazer modal para frente: movendo para o final do <body> e garantindo z-index alto
        const originalParent = modal.parentElement;
        const originalNext = modal.nextSibling;
        document.body.appendChild(modal);
        const originalZ = modal.style.zIndex || '';
        modal.style.zIndex = '3000';

        const titleEl = modal.querySelector('#confirmModalTitle');
        const msgEl = modal.querySelector('#confirmModalMessage');
        const okBtn = modal.querySelector('#confirmOkBtn');
        const cancelBtn = modal.querySelector('#confirmCancelBtn');
        const closeBtn = modal.querySelector('.close-x');

        // set labels
        titleEl.textContent = title;
        msgEl.textContent = message;
        okBtn.textContent = okLabel;
        cancelBtn.textContent = cancelLabel;
        cancelBtn.style.display = ''; // garantir visível
        // danger style
        okBtn.classList.toggle('danger', !!okIsDanger);

        const onOk = () => { cleanup(); resolve(true); };
        const onCancel = () => { cleanup(); resolve(false); };
        const onClose = () => { onCancel(); };

        function restorePosition() {
          try {
            if (originalParent) {
              if (originalNext) originalParent.insertBefore(modal, originalNext);
              else originalParent.appendChild(modal);
            }
          } catch (e) {
            // ignore
          } finally {
            modal.style.zIndex = originalZ;
          }
        }

        function cleanup(){
          okBtn.removeEventListener('click', onOk);
          cancelBtn.removeEventListener('click', onCancel);
          if (closeBtn) closeBtn.removeEventListener('click', onClose);
          okBtn.classList.remove('danger');
          _closeModalById('confirmModal');
          restorePosition();
        }

        okBtn.addEventListener('click', onOk);
        cancelBtn.addEventListener('click', onCancel);
        if (closeBtn) closeBtn.addEventListener('click', onClose);

        _openModalById('confirmModal');
      });
    }

    // Alerta simples (modal) - resolve quando fechar — movemos modal para o topo também
    function showAlert({ title = 'Aviso', message = 'Operação concluída.' } = {}) {
      return new Promise(resolve => {
        const modal = byId('confirmModal');
        if (!modal) { window.alert(message); resolve(); return; }

        // Trazer modal para frente
        const originalParent = modal.parentElement;
        const originalNext = modal.nextSibling;
        document.body.appendChild(modal);
        const originalZ = modal.style.zIndex || '';
        modal.style.zIndex = '3000';

        const titleEl = modal.querySelector('#confirmModalTitle');
        const msgEl = modal.querySelector('#confirmModalMessage');
        const okBtn = modal.querySelector('#confirmOkBtn');
        const cancelBtn = modal.querySelector('#confirmCancelBtn');
        const closeBtn = modal.querySelector('.close-x');

        titleEl.textContent = title;
        msgEl.textContent = message;
        okBtn.textContent = 'OK';
        cancelBtn.style.display = 'none';
        okBtn.classList.remove('danger');

        const onOk = () => { cleanup(); resolve(); };
        const onClose = () => { cleanup(); resolve(); };

        function restorePosition() {
          try {
            if (originalParent) {
              if (originalNext) originalParent.insertBefore(modal, originalNext);
              else originalParent.appendChild(modal);
            }
          } catch (e) {
            // ignore
          } finally {
            modal.style.zIndex = originalZ;
          }
        }

        function cleanup(){
          okBtn.removeEventListener('click', onOk);
          if (closeBtn) closeBtn.removeEventListener('click', onClose);
          cancelBtn.style.display = '';
          _closeModalById('confirmModal');
          restorePosition();
        }

        okBtn.addEventListener('click', onOk);
        if (closeBtn) closeBtn.addEventListener('click', onClose);

        _openModalById('confirmModal');
      });
    }

    /* ========= Loading / Render control ========= */
    function showLoading(show){
      const loading = byId('estadoLoading');
      const container = byId('estadoContainer');
      if (!loading || !container) return;
      if (show){
        loading.style.display = 'flex';
      } else {
        loading.style.display = 'none';
      }
    }

    function renderWhenReady(){
      if (popsLoaded && switchesLoaded){
        clearTimeout(loadFallbackTimer);
        showLoading(false);
        renderEstadosComPops();
      }
    }

    // fallback para evitar loading infinito se Firebase falhar
    function startLoadFallbackTimer(timeoutMs = 8000){
      clearTimeout(loadFallbackTimer);
      loadFallbackTimer = setTimeout(()=>{
        if (!(popsLoaded && switchesLoaded)){
          showLoading(false);
          const wrap = byId('estadoContainer');
          if (wrap) {
            wrap.innerHTML = '<div class="no-pops">Não foi possível carregar os POPs. Verifique sua conexão ou tente novamente. Use “Novo cadastro” para adicionar um POP localmente.</div>';
          }
        }
      }, timeoutMs);
    }

    /* ========= Render ========= */
    function popsByEstado(){
      const groups = {};
      pops.forEach(p=>{
        const uf = p.estado || '__';
        (groups[uf] ??= []).push(p);
      });
      Object.keys(groups).forEach(uf=> groups[uf].sort((a,b)=> a.nome.localeCompare(b.nome,'pt-BR')));
      return groups;
    }

    function renderEstadosComPops(){
      const wrap = byId('estadoContainer'); if(!wrap) return;
      if(!pops || pops.length===0){ wrap.innerHTML='<div class="no-pops">Nenhum POP cadastrado ainda. Use “Novo cadastro”.</div>'; return; }
      const groups = popsByEstado();
      const ufs = Object.keys(groups).sort((a,b)=>{ if(a==='__') return 1; if(b==='__') return -1; return a.localeCompare(b); });
      wrap.innerHTML = '';
      ufs.forEach(uf=>{
        const bloco = document.createElement('div');
        bloco.className = 'estado-block';
        const totalSwitchesUF = groups[uf].reduce((acc,p)=> acc + switches.filter(s=>s.pop===p.id).length, 0);
        bloco.innerHTML = `
          <div class="estado-head">
            <div class="h3">${estadoLabel(uf)}</div>
            <div class="estado-badge">${groups[uf].length} POP${groups[uf].length===1?'':'s'} • ${totalSwitchesUF} switch${totalSwitchesUF===1?'':'es'}</div>
          </div>
          <div class="pop-grid"></div>
        `;
        const grid = bloco.querySelector('.pop-grid');

        groups[uf].forEach(pop=>{
          const card = document.createElement('div');
          card.className='pop-card';
          const swDoPop = switches.filter(s=>s.pop===pop.id);
          card.innerHTML = `
            <div class="pop-header">
              <div class="pop-title">${pop.nome}</div>
              <div class="pop-badge">${swDoPop.length} switch${swDoPop.length===1?'':'es'}</div>
            </div>
            <button class="pop-toggle" data-toggle-pop="${pop.id}" aria-expanded="false">
              <span>Ver switches</span><i>▼</i>
            </button>
            <div class="switch-list">
              ${
                swDoPop.length===0
                ? `<div class="no-switches" style="padding:16px">Nenhum switch vinculado a este POP.</div>`
                : swDoPop.map(sw=>`
                    <div class="switch-row" data-switch-id="${sw.id}">
                      <div class="switch-info-wrap">
                        <div class="switch-name">${sw.nome}</div>
                        <div class="switch-meta">IP: ${sw.ip}</div>
                        <div class="switch-meta">Modelo: ${sw.modelo ? sw.modelo : '—'}</div>
                      </div>
                      <div class="row-actions">
                        <button class="btn small" data-action="edit">Editar</button>
                        <button class="btn danger small" data-action="delete">Excluir</button>
                      </div>
                      <div class="hover-preview">
                        ${ sw.foto ? `<img src="${sw.foto}" alt="Foto de ${sw.nome}">` : `<div class="noimg">Sem imagem para este switch</div>` }
                      </div>
                    </div>
                  `).join('')
              }
            </div>`;
          grid.appendChild(card);
        });

        wrap.appendChild(bloco);
      });
    }

    function renderUFSelect(selectEl){
      if(!selectEl) return;
      selectEl.innerHTML = `<option value="__">Sem Estado</option>` + estados.map(uf=>`<option value="${uf}">${uf}</option>`).join('');
    }
    function renderPopOptions(){
      const sel = byId('pop'); if(!sel) return;
      if(!pops || pops.length===0){ sel.innerHTML = '<option value="">Cadastre um POP</option>'; return; }
      const groups = popsByEstado();
      const ufs = Object.keys(groups).sort((a,b)=>{ if(a==='__') return 1; if(b==='__') return -1; return a.localeCompare(b); });
      sel.innerHTML = ufs.map(uf=>{
        const options = groups[uf].map(p=>`<option value="${p.id}">${p.nome}</option>`).join('');
        return `<optgroup label="${estadoLabel(uf)}">${options}</optgroup>`;
      }).join('');
    }

    /* ========= CRUD ========= */
    function openModal(id){ const el=byId(id); if(el){ el.classList.add('open'); el.setAttribute('aria-hidden','false'); } }
    function closeModal(id){ const el=byId(id); if(el){ el.classList.remove('open'); el.setAttribute('aria-hidden','true'); } }

    function openCadastroModal() {
      openModal('modalCadastro'); renderPopOptions();
      const tipoSel = byId('tipoCadastro'); tipoSel.value = 'switch';
      bindTipoCadastroEvents(); alternarTipo();
    }
    function bindTipoCadastroEvents() {
      const sel = byId('tipoCadastro'); const clone = sel.cloneNode(true);
      sel.parentNode.replaceChild(clone, sel);
      clone.addEventListener('change', alternarTipo);
      clone.addEventListener('input',  alternarTipo);
      document.addEventListener('change', (e)=>{ if(e.target && e.target.id==='tipoCadastro') alternarTipo(); }, { once:true });
    }
    function alternarTipo() {
      const tipo = (byId('tipoCadastro')?.value) || 'switch';
      const popBox = byId('camposPOP'); const swBox = byId('camposSW');
      const showPop = (tipo === 'pop');
      popBox.classList.toggle('hide', !showPop); swBox.classList.toggle('hide', showPop);
      popBox.style.display = showPop ? 'block' : 'none';
      swBox.style.display  = showPop ? 'none'  : 'block';
    }

    async function cadastrarPOP(){
      const nome=(byId('popNome').value||'').trim();
      if(!nome){ await showAlert({ title:'Atenção', message:'Informe o Nome/Descrição do POP.' }); return; }
      const uf = (byId('popEstado').value||'__'); const id=slugify(nome);
      const exists=pops.some(p=>p.id===id||p.nome.toLowerCase()===nome.toLowerCase());
      if(exists){ await showAlert({ title:'Atenção', message:'Já existe um POP com esse nome.' }); return; }
      pops.push({ id, nome, estado: uf }); savePops(); renderPopOptions(); renderEstadosComPops();
      resetCadastroForm(); closeModal('modalCadastro');
      await showAlert({ title:'Sucesso', message:'POP cadastrado com sucesso.' });
    }

    async function cadastrarSwitch(){
      const popSel=byId('pop').value; const ip=byId('ip').value.trim(); const nome=byId('nome').value.trim();
      const modelo=(byId('modelo').value||'').trim(); const fotoInput=byId('foto');
      if(!popSel||!ip||!nome){ await showAlert({ title:'Atenção', message:'Por favor, preencha os campos POP, IP e Nome do switch.' }); return; }
      if(!validarIP(ip)){ await showAlert({ title:'Atenção', message:'Endereço IP inválido. Informe um IPv4 válido (ex.: 192.168.1.100).' }); return; }
      const sw={ id:String(Date.now()), pop:popSel, ip, nome, modelo: modelo || null, foto:null };
      if (fotoInput.files && fotoInput.files[0]) {
        const file = fotoInput.files[0];
        try {
          const dataURL = await compressAdaptively(file);
          sw.foto = dataURL;
        } catch (err) {
          console.warn('Erro compressão imagem', err);
          await showAlert({ title:'Aviso', message:'Não foi possível processar a imagem. O switch será salvo sem foto.' });
        }
      }
      finalizarCadastroSwitch(sw);
    }
    async function finalizarCadastroSwitch(sw){
      switches.push(sw); saveSwitches(); renderPopOptions(); renderEstadosComPops();
      resetCadastroForm(); closeModal('modalCadastro');
      await showAlert({ title:'Sucesso', message:'Switch cadastrado com sucesso.' });
    }
    function resetCadastroForm(){
      byId('cadastroForm').reset(); const tipoSel=byId('tipoCadastro'); tipoSel.value='switch'; alternarTipo(); renderUFSelect(byId('popEstado'));
    }

    function openEditSwitch(id){
      const sw=switches.find(s=>s.id===id); if(!sw) return;
      byId('editSwitchId').value=String(sw.id); byId('editSwitchNome').value=sw.nome; byId('editSwitchIP').value=sw.ip;
      const sel=byId('editSwitchPop'); sel.innerHTML=pops.map(p=>`<option value="${p.id}">${estadoLabel(p.estado)} — ${p.nome}</option>`).join(''); sel.value=sw.pop;
      byId('editSwitchModelo').value=sw.modelo||''; byId('previewInfo').dataset.remove='false';
      byId('previewInfo').textContent=sw.foto?'Imagem atual presente.':'Sem imagem.'; byId('editSwitchFoto').value='';
      openModal('modalEditSwitch');
    }
    async function saveEditSwitch(ev){
      ev && ev.preventDefault();
      const idString = byId('editSwitchId').value;
      const id = idString && !isNaN(Number(idString)) ? Number(idString) : idString;
      const nome=byId('editSwitchNome').value.trim();
      const ip=byId('editSwitchIP').value.trim(); const popSel=byId('editSwitchPop').value;
      const modelo=(byId('editSwitchModelo').value||'').trim();
      const fotoInput=byId('editSwitchFoto'); const removeFlag=byId('previewInfo').dataset.remove==='true';
      if(!nome||!ip||!popSel){ await showAlert({ title:'Atenção', message:'Preencha Nome, IP e POP.' }); return; }
      if(!validarIP(ip)){ await showAlert({ title:'Atenção', message:'Endereço IP inválido. Informe um IPv4 válido (ex.: 192.168.1.100).' }); return; }
      const idx=switches.findIndex(s=>s.id===id); if(idx===-1) return;
      const applyAndClose= async (newFoto)=>{
        switches[idx].nome=nome; switches[idx].ip=ip; switches[idx].pop=popSel; switches[idx].modelo=modelo||null;
        if(removeFlag) switches[idx].foto=null; if(newFoto!==undefined) switches[idx].foto=newFoto;
        saveSwitches(); renderPopOptions(); renderEstadosComPops(); closeModal('modalEditSwitch');
        await showAlert({ title:'Sucesso', message:'Alterações salvas com sucesso.' });
      };
      if (fotoInput.files && fotoInput.files[0]) {
        const file = fotoInput.files[0];
        try {
          const dataURL = await compressAdaptively(file);
          await applyAndClose(dataURL);
        } catch (err) {
          console.warn('Erro processar nova imagem', err);
          await showAlert({ title:'Aviso', message:'Não foi possível processar a nova imagem. Os demais dados serão salvos.' });
          await applyAndClose();
        }
      } else {
        await applyAndClose();
      }
    }
    async function deleteSwitch(id){
      const ok = await showConfirm({
        title: 'Confirmar exclusão',
        message: 'Tem certeza de que deseja remover este switch permanentemente? Esta ação não pode ser desfeita.',
        okLabel: 'Remover',
        cancelLabel: 'Cancelar',
        okIsDanger: true
      });
      if (!ok) return;
      switches = switches.filter(s=>s.id!==id);
      saveSwitches(); renderPopOptions(); renderEstadosComPops();
      await showAlert({ title:'Removido', message:'O switch foi removido.' });
    }

    function openModalPops(){ buildPopsTable(); openModal('modalPops'); }
    function buildPopsTable(){
      const tbody=byId('tabelaPops').querySelector('tbody'); tbody.innerHTML='';
      pendingPopEdits=pops.map(p=>({ oldId:p.id, id:p.id, nome:p.nome, estado:p.estado||'__', _delete:false }));
      pendingPopEdits.forEach((row,i)=>{
        const vinculados=switches.filter(s=>s.pop===row.id).length;
        const tr=document.createElement('tr'); tr.dataset.index=i;
        const ufSelect = `<select data-field="estado">${['__',...estados].map(uf=>`<option value="${uf}" ${uf===row.estado?'selected':''}>${estadoLabel(uf)}</option>`).join('')}</select>`;
        tr.innerHTML = `
          <td><input type="text" value="${row.nome.replace(/"/g,'&quot;')}" data-field="nome"></td>
          <td>${ufSelect}</td>
          <td><input type="text" value="${row.id.replace(/"/g,'&quot;')}" data-field="id" disabled></td>
          <td>${vinculados}</td>
          <td class="row-actions">
            <button class="btn small" data-act="renomear">Gerar ID</button>
            <button class="btn danger small" data-act="excluir">Excluir</button>
          </td>`;
        tbody.appendChild(tr);
      });
      tbody.onclick=(ev)=>{
        const tr=ev.target.closest('tr'); if(!tr) return; const idx=Number(tr.dataset.index);
        if(ev.target.matches('[data-act="renomear"]')){
          const nomeInput=tr.querySelector('input[data-field="nome"]');
          const idInput=tr.querySelector('input[data-field="id"]');
          const novoId=slugify(nomeInput.value.trim());
          idInput.value=novoId; pendingPopEdits[idx].id=novoId; pendingPopEdits[idx].nome=nomeInput.value.trim();
        }
        if(ev.target.matches('[data-act="excluir"]')){
          const idAtual=pendingPopEdits[idx].id;
          const vinculados=switches.filter(s=>s.pop===idAtual).length;
          if(vinculados>0){ showAlert({ title:'Atenção', message:'Não é possível excluir: existem switches vinculados a este POP.' }); return; }
          (async ()=>{
            const ok = await showConfirm({
              title: 'Confirmar exclusão',
              message: 'Deseja realmente excluir este POP? Esta operação não pode ser desfeita.',
              okLabel: 'Excluir',
              cancelLabel: 'Cancelar',
              okIsDanger: true
            });
            if (!ok) return;
            pendingPopEdits[idx]._delete=true; tr.style.opacity=.5;
          })();
        }
      };
      tbody.oninput=(ev)=>{
        const tr=ev.target.closest('tr'); if(!tr) return; const idx=Number(tr.dataset.index);
        if(ev.target.dataset.field==='nome') pendingPopEdits[idx].nome=ev.target.value;
        if(ev.target.dataset.field==='estado') pendingPopEdits[idx].estado=ev.target.value;
      };
      tbody.onchange = tbody.oninput;
    }
    async function applyPopEdits(){
      const effective=pendingPopEdits.filter(r=>!r._delete);
      const ids=effective.map(r=>r.id);
      const nomes=effective.map(r=>r.nome.trim().toLowerCase());
      if(ids.length!==new Set(ids).size){ await showAlert({ title:'Atenção', message:'IDs (slug) duplicados após edição. Ajuste os nomes/IDs.' }); return; }
      if(nomes.length!==new Set(nomes).size){ await showAlert({ title:'Atenção', message:'Nomes duplicados após edição. Ajuste os nomes.' }); return; }
      pendingPopEdits.filter(r=>r._delete).forEach(rem=>{ pops=pops.filter(p=>p.id!==rem.oldId); });
      pendingPopEdits.filter(r=>!r._delete).forEach(edit=>{
        const pIdx=pops.findIndex(p=>p.id===edit.oldId); if(pIdx===-1) return;
        const idChanged=edit.oldId!==edit.id;
        pops[pIdx].id=edit.id; pops[pIdx].nome=edit.nome; pops[pIdx].estado=edit.estado || '__';
        if(idChanged){ switches.forEach(s=>{ if(s.pop===edit.oldId) s.pop=edit.id; }); }
      });
      savePops(); saveSwitches(); renderPopOptions(); renderEstadosComPops(); closeModal('modalPops');
      await showAlert({ title:'Sucesso', message:'POPs atualizados.' });
    }

    /* ========= Listeners globais ========= */
    document.addEventListener('DOMContentLoaded', () => {
      // Fechar modais via botão [x] e botão com data-close
      document.querySelectorAll('[data-close]').forEach(btn =>
        btn.addEventListener('click', (e)=> closeModal(e.currentTarget.getAttribute('data-close')))
      );

      // Estado inicial salvo (desktop)
      const saved = localStorage.getItem(LS_SIDEBAR_STATE);
      if (saved === '1' && !isMobile()) document.body.classList.add('sidebar-collapsed');

      // Botão colapsar/expandir
      byId('btnCollapse').addEventListener('click', () => {
        if (isMobile()) document.body.classList.toggle('sidebar-open');
        else setCollapsed(!document.body.classList.contains('sidebar-collapsed'));
        setTimeout(scheduleAutoHide, 0);
      });

      // Overlay fecha no mobile
      document.querySelector('.sidebar-overlay').addEventListener('click', ()=>{
        document.body.classList.remove('sidebar-open'); cancelAutoHide();
      });

      // Edge hitbox (abre no mobile)
      const edge = byId('edgeHitbox');
      if (edge){
        let startX = null;
        edge.addEventListener('touchstart', (e)=>{ if (!isMobile()) return; startX = e.touches[0].clientX; });
        edge.addEventListener('touchmove', (e)=>{
          if (!isMobile() || startX===null) return;
          const dx = e.touches[0].clientX - startX;
          if (dx > 12){ document.body.classList.add('sidebar-open'); startX = null; scheduleAutoHide(); }
        });
        edge.addEventListener('click', ()=>{ if (isMobile()) { document.body.classList.add('sidebar-open'); scheduleAutoHide(); } });
      }

      // Itens de ação da sidebar — também fecham o menu imediatamente
      byId('menuNovoCadastro').addEventListener('click', () => {
        closeSidebar(); cancelAutoHide(); openCadastroModal();
      });
      byId('menuGerenciarPops').addEventListener('click', () => {
        closeSidebar(); cancelAutoHide(); openModalPops();
      });

      // Ações dos botões dos modais
      byId('btnSalvarCadastro').addEventListener('click', async (e)=>{ e.preventDefault(); const tipo=byId('tipoCadastro').value; if(tipo==='pop') await cadastrarPOP(); else await cadastrarSwitch(); });
      byId('btnSalvarEditSwitch').addEventListener('click', saveEditSwitch);
      byId('btnRemoverFoto').addEventListener('click', () => { byId('editSwitchFoto').value=''; byId('previewInfo').textContent='Imagem será removida ao salvar.'; byId('previewInfo').dataset.remove='true'; });
      byId('btnSalvarPops').addEventListener('click', applyPopEdits);

      // Lista de POPs: acordeão + ações editar/excluir
      byId('estadoContainer').addEventListener('click', (ev) => {
        const toggleBtn = ev.target.closest('[data-toggle-pop]');
        if (toggleBtn) {
          const card = toggleBtn.closest('.pop-card');
          const list = card.querySelector('.switch-list');
          const popId = toggleBtn.getAttribute('data-toggle-pop');
          const isOpen = list.style.display === 'block';
          if (isOpen) { toggleBtn.classList.remove('open'); toggleBtn.setAttribute('aria-expanded','false'); list.style.display = 'none'; }
          else { closeAllPopLists(popId); toggleBtn.classList.add('open'); toggleBtn.setAttribute('aria-expanded','true'); list.style.display = 'block'; }
          return;
        }
        const swBtn = ev.target.closest('[data-action]');
        if (swBtn) {
          const action = swBtn.dataset.action;
          const swId = swBtn.closest('[data-switch-id]')?.dataset.switchId;
          if (!swId) return;
          const isNumeric = !isNaN(Number(swId));
          const swIdParsed = isNumeric ? Number(swId) : swId;
          if (action === 'edit') openEditSwitch(swIdParsed);
          if (action === 'delete') deleteSwitch(swIdParsed);
        }
      });

      // Hover tracking para auto-hide
      const sidebarEl = document.querySelector('.sidebar');
      if (sidebarEl){
        sidebarEl.addEventListener('mouseenter', ()=>{ isSidebarHovered = true; cancelAutoHide(); });
        sidebarEl.addEventListener('mouseleave', ()=>{ isSidebarHovered = false; scheduleAutoHide(); });
      }

      // Observador para reagendar auto-hide automaticamente
      const bodyObserver = new MutationObserver(()=> {
        if (isSidebarOpen()) scheduleAutoHide(); else cancelAutoHide();
      });
      bodyObserver.observe(document.body, { attributes:true, attributeFilter:['class'] });

      // Resize
      window.addEventListener('resize', () => {
        if (!isMobile()) document.body.classList.remove('sidebar-open');
        const saved = localStorage.getItem(LS_SIDEBAR_STATE) === '1';
        if (!isMobile()) setCollapsed(saved);
        setTimeout(()=>{ if (isSidebarOpen()) scheduleAutoHide(); else cancelAutoHide(); }, 0);
      });

      // Atalho (Ctrl+B) para colapsar/expandir no desktop
      document.addEventListener('keydown', (e)=>{
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==='b' && !isMobile()){
          e.preventDefault(); setCollapsed(!document.body.classList.contains('sidebar-collapsed'));
          setTimeout(scheduleAutoHide, 0);
        }
      });

      // Sincroniza estado inicial e agenda auto-hide se já estiver aberta
      setCollapsed(document.body.classList.contains('sidebar-collapsed'));
      if (isSidebarOpen()) scheduleAutoHide();

      // start fallback timer para evitar loading infinito
      startLoadFallbackTimer(8000);
    });
  </script>
</body>
</html>
