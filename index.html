<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gestão de POPs - Modern</title>
  <style>
    :root {
      --primary-color: #3b82f6;
      --primary-color-hover: #2563eb;
      --background-light: #f9fafb;
      --background-card: #ffffff;
      --text-primary: #1f2937;
      --text-secondary: #4b5563;
      --border-color: #e5e7eb;
      --shadow-light: rgba(0, 0, 0, 0.05);
      --shadow-hover: rgba(0, 0, 0, 0.1);
      --radius: 12px;
      --transition-fast: 0.2s ease;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background: var(--background-light); color: var(--text-primary); line-height: 1.5; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
    .container { max-width: 1200px; margin: 0 auto; padding: 24px 20px; }

    header {
      background: linear-gradient(135deg, #2563eb, #3b82f6);
      color: white;
      padding: 24px 20px;
      border-radius: var(--radius);
      margin-bottom: 28px;
      box-shadow: 0 8px 24px var(--shadow-hover);
      text-align: center;
    }
    h1 { font-weight: 700; font-size: 1.8rem; margin-bottom: 8px; }
    .subtitle { font-weight: 400; font-size: 0.95rem; opacity: 0.95; }

    .panel {
      background: var(--background-card);
      padding: 22px;
      border-radius: var(--radius);
      box-shadow: 0 4px 16px var(--shadow-light);
    }

    .search-row { display: flex; gap: 12px; align-items: center; margin-bottom: 18px; }
    #popSearch {
      width: 100%;
      padding: 12px 16px;
      font-size: 1rem;
      border-radius: var(--radius);
      border: 1.5px solid var(--border-color);
      transition: border-color var(--transition-fast);
      outline-offset: 2px;
      color: var(--text-primary);
      background: white;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.06);
    }
    #popSearch:focus { border-color: var(--primary-color); box-shadow: 0 0 8px rgba(59,130,246,0.15); }

    #popSearchClear {
      padding: 10px 14px;
      font-size: 0.95rem;
      border-radius: var(--radius);
      border: 1.5px solid var(--primary-color);
      background: transparent;
      color: var(--primary-color);
      cursor: pointer;
      transition: background-color var(--transition-fast), color var(--transition-fast);
    }
    #popSearchClear:hover { background-color: var(--primary-color); color: white; }

    .pop-grid { display: flex; flex-wrap: wrap; gap: 18px; margin-top: 6px; align-items: flex-start; }
    .pop-card {
      flex: 1 1 320px;
      max-width: 420px;
      background: var(--background-card);
      border-radius: var(--radius);
      box-shadow: 0 2px 12px var(--shadow-light);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      display: flex; flex-direction: column;
    }
    .pop-card:hover { transform: translateY(-6px); box-shadow: 0 8px 24px var(--shadow-hover); }

    .pop-header { display:flex; align-items:center; justify-content:space-between; padding:16px 18px; border-bottom:1px solid var(--border-color); }
    .pop-title { font-size:1.2rem; font-weight:700; color:var(--text-primary); }
    .pop-badge { background: var(--background-light); padding:6px 12px; border-radius:9999px; font-size:0.85rem; color:var(--text-secondary); font-weight:600; }

    .pop-toggle {
      width:100%;
      border:none;
      padding:14px 18px;
      background:var(--background-light);
      border-top:1px solid var(--border-color);
      font-weight:600;
      display:flex;
      align-items:center;
      justify-content:space-between;
      cursor:pointer;
      border-radius: 0 0 var(--radius) var(--radius);
      transition: background-color var(--transition-fast), color var(--transition-fast);
    }
    .pop-toggle:hover { background-color: var(--primary-color); color:white; }
    .pop-toggle i { transition: transform .25s ease; }
    .pop-toggle.open i { transform: rotate(180deg); }

    .switch-list { display:none; padding:12px 18px 18px 18px; gap:12px; flex-direction:column; }
    .switch-list.open { display:flex; }

    .switch-row {
      background: var(--background-light);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      cursor:default;
    }
    .switch-info-wrap { display:flex; flex-direction:column; gap:4px; min-width:0; flex:1; }
    .switch-name { font-weight:700; color:var(--text-primary); font-size:1rem; word-break:break-word; }
    .switch-meta { font-size:0.9rem; color:var(--text-secondary); }

    .hover-preview {
      position:absolute;
      top:50%;
      left:100%;
      transform:translate(12px,-50%) scale(0.98);
      width:320px;
      background:var(--background-card);
      border:1px solid #d1d5db;
      border-radius:var(--radius);
      box-shadow:0 12px 32px rgba(0,0,0,0.12);
      padding:12px;
      opacity:0;
      pointer-events:none;
      transition: opacity .15s ease, transform .15s ease;
      z-index:999;
    }
    .switch-row:hover .hover-preview { opacity:1; transform:translate(12px,-50%) scale(1); pointer-events:auto; }
    .hover-preview img { width:100%; height:auto; display:block; border-radius:8px; object-fit:cover; max-height:200px; }
    .hover-preview .noimg { color:var(--text-secondary); font-size:0.9rem; text-align:center; padding:10px; }

    .btn { background:var(--primary-color); color:white; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:700; }
    .btn.ghost { background:transparent; color:var(--primary-color); border:2px solid var(--primary-color); }
    .btn.small { padding:6px 10px; font-size:0.9rem; }

    /* responsividade simples */
    @media (max-width:800px) {
      .pop-grid { flex-direction:column; }
      .hover-preview { display:none; } /* evitar overflow em mobile */
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Gestão de POPs</h1>
      <div class="subtitle">Busque POPs por nome — pesquisa case-insensitive com debounce</div>
    </header>

    <section class="panel">
      <div class="search-row">
        <input id="popSearch" type="search" placeholder="Pesquisar POP por nome..." aria-label="Pesquisar POP por nome" />
        <button id="popSearchClear" class="btn ghost small" type="button">Limpar</button>
      </div>

      <div id="estadosContainer" class="pop-grid" aria-live="polite">
        <!-- Cards dos estados e POPs serão renderizados aqui -->
      </div>
    </section>
  </div>

  <!-- Modal simples (placeholder) -->
  <div id="popModal" class="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:1100;">
    <div style="background:white; border-radius:12px; width:min(900px,96%); max-height:90vh; overflow:auto; padding:18px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <h3 style="margin:0;">Detalhes do POP</h3>
        <button onclick="closePopModal()" class="btn ghost small">Fechar</button>
      </div>
      <div id="popModalBody">Conteúdo do POP</div>
    </div>
  </div>

  <script>
    /******* Dados de exemplo (substitua/carregue do Firebase) *******/
    let popsByEstado = {}; // será preenchido pela função loadPopsFromFirebase

    function loadPopsFromFirebase() {
      // Substitua esta função pela sua integração real com Firebase.
      // Aqui eu coloco dados de exemplo para que a página funcione imediatamente.
      popsByEstado = {
        "SP": [
          { id: "sp-1", nome: "POP Operação X", descricao: "Procedimento X detalhado", switches: [
            { id: "s1", nome: "Switch A", modelo: "Model-A", imagem: "" },
            { id: "s2", nome: "Switch B", modelo: "Model-B", imagem: "" }
          ]},
          { id: "sp-2", nome: "POP Segurança", descricao: "Checklist de segurança", switches: [] }
        ],
        "RJ": [
          { id: "rj-1", nome: "POP Atendimento", descricao: "Fluxo de atendimento", switches: [
            { id: "s3", nome: "Switch C", modelo: "Model-C", imagem: "" }
          ] }
        ],
        "MG": [
          { id: "mg-1", nome: "POP Manutenção Preventiva", descricao: "Inspeção mensal", switches: [] }
        ]
      };

      // Depois de carregar, renderiza.
      renderEstadosComPops();
    }

    /******* Debounce utilitário *******/
    function debounce(fn, wait) {
      let t;
      return function(...args) {
        clearTimeout(t);
        t = setTimeout(() => fn.apply(this, args), wait);
      };
    }

    /******* Renderização: filtra por pop.nome (case-insensitive) *******/
    function renderEstadosComPops() {
      const container = document.getElementById('estadosContainer');
      container.innerHTML = '';

      const rawSearch = (document.getElementById('popSearch') || {}).value || '';
      const search = rawSearch.trim().toLowerCase();

      // percorre cada estado
      Object.keys(popsByEstado).sort().forEach(estado => {
        const pops = popsByEstado[estado] || [];
        // filtra POPs pelo nome (case-insensitive)
        const popsFiltrados = pops.filter(pop => {
          if (!search) return true;
          return (pop.nome || '').toLowerCase().includes(search);
        });

        if (popsFiltrados.length === 0) return; // não mostra estados sem POP correspondentes

        // cria um card por estado contendo POPs (cada POP vira um cartão)
        popsFiltrados.forEach(pop => {
          const card = document.createElement('div');
          card.className = 'pop-card';
          card.style.position = 'relative';

          // header
          const header = document.createElement('div');
          header.className = 'pop-header';
          const title = document.createElement('div');
          title.className = 'pop-title';
          title.textContent = pop.nome || '(Sem nome)';
          const badge = document.createElement('div');
          badge.className = 'pop-badge';
          badge.textContent = estado;

          header.appendChild(title);
          header.appendChild(badge);

          // toggle
          const toggle = document.createElement('button');
          toggle.className = 'pop-toggle';
          toggle.type = 'button';
          toggle.innerHTML = `<span style="font-weight:700;">Detalhes</span> <i>▾</i>`;

          // lista de switches (inicialmente escondida)
          const switchList = document.createElement('div');
          switchList.className = 'switch-list';

          const switches = pop.switches || [];
          if (switches.length === 0) {
            const emptyRow = document.createElement('div');
            emptyRow.className = 'switch-row';
            emptyRow.innerHTML = `<div class="switch-info-wrap"><div class="switch-name">Nenhum switch listado</div><div class="switch-meta">Adicione switches a este POP</div></div>`;
            switchList.appendChild(emptyRow);
          } else {
            switches.forEach(sw => {
              const row = document.createElement('div');
              row.className = 'switch-row';
              row.style.position = 'relative';

              const info = document.createElement('div');
              info.className = 'switch-info-wrap';
              const swName = document.createElement('div');
              swName.className = 'switch-name';
              swName.textContent = sw.nome || 'Sem nome';
              const swMeta = document.createElement('div');
              swMeta.className = 'switch-meta';
              swMeta.textContent = sw.modelo ? `Modelo: ${sw.modelo}` : '';

              info.appendChild(swName);
              info.appendChild(swMeta);

              // hover preview (imagem + modelo + botão copiar)
              const preview = document.createElement('div');
              preview.className = 'hover-preview';
              if (sw.imagem) {
                const img = document.createElement('img');
                img.src = sw.imagem;
                img.alt = sw.nome || '';
                preview.appendChild(img);
              } else {
                const noimg = document.createElement('div');
                noimg.className = 'noimg';
                noimg.textContent = '(sem imagem)';
                preview.appendChild(noimg);
              }

              const modelBlock = document.createElement('div');
              modelBlock.style.marginTop = '8px';
              modelBlock.innerHTML = `<strong>${sw.modelo || 'Modelo não especificado'}</strong><div style="color:var(--text-secondary); margin-top:6px;">${(pop.descricao || '')}</div>`;
              preview.appendChild(modelBlock);

              const copyBtn = document.createElement('button');
              copyBtn.className = 'btn small';
              copyBtn.textContent = 'Copiar nome';
              copyBtn.style.marginTop = '8px';
              copyBtn.onclick = (e) => {
                e.stopPropagation();
                navigator.clipboard?.writeText(sw.nome || '').then(() => {
                  copyBtn.textContent = 'Copiado!';
                  setTimeout(() => copyBtn.textContent = 'Copiar nome', 1200);
                }).catch(()=> {
                  copyBtn.textContent = 'Erro';
                  setTimeout(() => copyBtn.textContent = 'Copiar nome', 1200);
                });
              };
              preview.appendChild(copyBtn);

              row.appendChild(info);
              row.appendChild(preview);

              // clique abre modal com mais detalhes
              row.addEventListener('click', () => {
                openPopModal(pop, sw);
              });

              switchList.appendChild(row);
            });
          }

          // toggle logic
          toggle.addEventListener('click', () => {
            const isOpen = toggle.classList.toggle('open');
            if (isOpen) {
              switchList.classList.add('open');
            } else {
              switchList.classList.remove('open');
            }
          });

          // montar card
          card.appendChild(header);
          card.appendChild(toggle);
          card.appendChild(switchList);

          container.appendChild(card);
        });
      });

      // Se não restaram POPs após filtro, mostra mensagem
      if (!container.hasChildNodes()) {
        const emptyMsg = document.createElement('div');
        emptyMsg.style.width = '100%';
        emptyMsg.style.textAlign = 'center';
        emptyMsg.style.color = 'var(--text-secondary)';
        emptyMsg.style.padding = '28px';
        emptyMsg.textContent = 'Nenhum POP encontrado para a pesquisa.';
        container.appendChild(emptyMsg);
      }
    }

    /******* Setup da pesquisa com debounce e botão limpar *******/
    function setupPopSearch() {
      const input = document.getElementById('popSearch');
      const clearBtn = document.getElementById('popSearchClear');

      if (!input) return;

      const debouncedRender = debounce(() => {
        renderEstadosComPops();
      }, 300);

      input.addEventListener('input', debouncedRender);

      clearBtn.addEventListener('click', () => {
        input.value = '';
        input.focus();
        renderEstadosComPops();
      });

      // Se o usuário pressionar Esc, limpa a pesquisa
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          input.value = '';
          renderEstadosComPops();
        }
      });
    }

    /******* Modal helpers *******/
    function openPopModal(pop, sw) {
      const modal = document.getElementById('popModal');
      const body = document.getElementById('popModalBody');
      const lines = [];
      lines.push(`<p><strong>POP:</strong> ${pop.nome || '(sem nome)'}</p>`);
      if (sw) lines.push(`<p><strong>Switch:</strong> ${sw.nome || '(sem nome)'}</p>`);
      if (pop.descricao) lines.push(`<p><strong>Descrição:</strong><br/>${pop.descricao}</p>`);
      body.innerHTML = lines.join('');
      modal.style.display = 'flex';
    }
    function closePopModal() {
      const modal = document.getElementById('popModal');
      modal.style.display = 'none';
    }

    /******* DOM ready *******/
    document.addEventListener('DOMContentLoaded', () => {
      setupPopSearch();
      loadPopsFromFirebase(); // substitua por sua rotina real de carregamento do Firebase
    });
  </script>
</body>
</html>
