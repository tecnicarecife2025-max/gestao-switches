<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestão de Switches de Rede</title>

  <!-- Favicon base (fallback) -->
  <link id="dynamic-favicon" rel="icon" type="image/png"
        href="https://cdn-icons-png.flaticon.com/512/3749/3749786.png" />
  <meta name="theme-color" content="#111923">

  <!-- Anti-flicker: inicia colapsado via variáveis e sem animações até .js-ready -->
  <style>
    html:not(.js-ready) * { transition: none !important; animation: none !important; }
    html { --sbw: 52px; --sbw-collapsed: 52px; }
    html.js-ready { --sbw: 260px; --sbw-collapsed: 52px; }
  </style>

  <style>
    :root{ --sbw:260px; --sbw-collapsed:52px }
    *{ margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif }
    body{ background:#f5f7fa; color:#333 }
    .container{ max-width:1200px; margin:0 auto; padding:20px }

    /* ===== Sidebar ===== */
    .sidebar{
      position:fixed; left:0; top:0; bottom:0; width:var(--sbw);
      background:linear-gradient(180deg,#1a2530,#111923);
      color:#e5e7eb; box-shadow:2px 0 12px rgba(0,0,0,.15); z-index:1100;
      transition:width .25s ease, transform .25s ease;
      will-change:width, transform; overflow-x:hidden;
      display:flex; flex-direction:column;
    }
    .brand{ display:flex; align-items:center; gap:10px; justify-content:space-between;
      padding:12px; border-bottom:1px solid rgba(255,255,255,.06); min-height:56px }
    .brand-left{ display:flex; align-items:center; gap:10px; min-width:0 }
    .logo{ width:36px; height:36px; border-radius:10px; background:#2b3b4a;
      display:grid; place-items:center; font-weight:800; color:#a7c7ff;
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.08) }
    .title{ font-size:14px; line-height:1.15; white-space:nowrap; transition:opacity .2s ease }
    .title b{ display:block; font-size:15px; color:#fff }
    .collapse-btn{
      background:#ffffff1a; border:1px solid #ffffff24; color:#fff;
      padding:8px 10px; border-radius:8px; cursor:pointer; transition:.2s;
      display:inline-flex; align-items:center; gap:8px; white-space:nowrap
    }
    .collapse-btn:hover{ background:#ffffff2d }
    .collapse-btn svg{ width:18px; height:18px; transition:transform .25s ease }

    .menu{ padding:10px; overflow:auto; flex:1 }
    .menu h4{ font-size:12px; color:#9fb0c2; letter-spacing:.06em; text-transform:uppercase;
      margin:10px 10px 6px; white-space:nowrap; transition:opacity .2s ease }
    .menu .item{
      display:flex; align-items:center; gap:10px; padding:12px 14px; margin:6px 6px;
      border-radius:10px; cursor:pointer; color:#e5e7eb; transition:.18s background, .18s transform;
      position:relative; white-space:nowrap; line-height:1;
    }
    .menu .item:hover{ background:rgba(255,255,255,.09) }
    .menu .item .icon{ width:22px; height:22px; display:grid; place-items:center; flex:0 0 22px; opacity:.95 }
    .menu .item .icon svg{ width:20px; height:20px }

    /* Rodapé fixo na sidebar: botão de cadeado */
    .sidebar-footer{
      padding:10px 6px 10px 6px;
      border-top:1px solid rgba(255,255,255,.06);
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:flex-start;
    }
    .lock-btn{
      display:flex; align-items:center; gap:10px; width:100%;
      background:#ffffff14; border:1px solid #ffffff24; color:#fff; cursor:pointer;
      padding:10px 12px; border-radius:10px; transition:background .2s ease, transform .1s ease
    }
    .lock-btn:hover{ background:#ffffff26 }
    .lock-btn:active{ transform:translateY(1px) }
    .lock-btn img{ width:20px; height:20px }
    .lock-badge{ margin-left:auto; font-size:12px; padding:.2rem .5rem; border-radius:999px; background:#0d1a24; border:1px solid #ffffff24 }

    /* Layout principal deslocado pela sidebar */
    .with-sidebar{ margin-left:var(--sbw); transition:margin-left .25s ease }

    /* Estado colapsado (desktop) */
    body.sidebar-collapsed .sidebar{ width:var(--sbw-collapsed) }
    body.sidebar-collapsed .with-sidebar{ margin-left:var(--sbw-collapsed) }
    body.sidebar-collapsed .title{ opacity:0; pointer-events:none }
    body.sidebar-collapsed .brand{ justify-content:center; gap:0 }
    body.sidebar-collapsed .logo{ display:none }
    body.sidebar-collapsed .collapse-btn span{ display:none }
    body.sidebar-collapsed .collapse-btn{ padding:8px }
    body.sidebar-collapsed .collapse-btn svg{ transform:rotate(180deg) }
    body.sidebar-collapsed .menu{ padding:8px 6px }
    body.sidebar-collapsed .menu h4{ height:0; margin:0; padding:0; opacity:0; overflow:hidden }
    body.sidebar-collapsed .menu .item{ justify-content:center; gap:0; padding:10px; margin:4px 6px; border-radius:12px }
    body.sidebar-collapsed .menu .item span{ display:none }

    /* Mobile */
    @media (max-width: 900px){
      .sidebar { transform:translateX(-100%) }
      body.sidebar-open .sidebar { transform:none }
      .with-sidebar { margin-left:0 }
      .sidebar-overlay{ content:""; position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; z-index:1000 }
      body.sidebar-open .sidebar-overlay{ display:block }
      .edge-hitbox{ position:fixed; left:0; top:0; bottom:0; width:18px; z-index:900; background:transparent }
    }
    @media (min-width:901px){ .edge-hitbox{ display:none } }

    /* Header/Sections */
    header{ background:linear-gradient(135deg,#2c3e50,#1a2530); color:#fff; padding:20px; border-radius:10px; margin-bottom:30px; box-shadow:0 4px 12px rgba(0,0,0,.1) }
    .header-row{ text-align:center; display:block }
    h1{ margin-bottom:6px }
    .subtitle{ opacity:.9; font-weight:300; white-space:nowrap }

    .btn{ background:#3498db; color:#fff; border:0; padding:12px 16px; border-radius:6px; cursor:pointer; font-weight:600; transition:.25s; display:inline-flex; align-items:center; gap:8px }
    .btn:hover{ background:#2980b9 }
    .btn.ghost{ background:#ecf0f1; color:#2c3e50 }
    .btn.ghost:hover{ background:#d5dbdb }
    .btn.danger{ background:#e74c3c }
    .btn.danger:hover{ background:#c0392b }
    .btn.small{ padding:8px 10px; font-size:14px }

    .main-content{ display:flex; gap:30px; flex-wrap:wrap }
    .switches-section{ background:#fff; padding:25px; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,.05); flex:1; min-width:320px }
    h2{ color:#2c3e50; margin-bottom:20px; padding-bottom:10px; border-bottom:2px solid #eee }
    .h3{ color:#2c3e50; margin:18px 0 10px; font-size:18px; font-weight:800 }
    .muted{ color:#7f8c8d; font-size:14px }
    .no-switches,.no-pops{ text-align:center; padding:40px; color:#7f8c8d; font-style:italic }

    .estado-block{ margin-bottom:32px }
    .estado-head{ display:flex; align-items:center; justify-content:space-between }
    .estado-badge{ background:#eef3f7; border:1px solid #e3e8ee; color:#2c3e50; font-weight:700; padding:4px 10px; border-radius:999px; font-size:12px }

    .pop-grid{ display:flex; flex-wrap:wrap; gap:20px; margin-top:12px; align-items:flex-start }
    .pop-card{ flex:1 1 320px; max-width:420px; background:#f8f9fa; border-radius:8px; overflow:visible; box-shadow:0 2px 8px rgba(0,0,0,.1); transition:transform .3s, box-shadow .3s }
    .pop-card:hover{ transform:translateY(-5px); box-shadow:0 5px 15px rgba(0,0,0,.1) }
    .pop-header{ display:flex; align-items:center; justify-content:space-between; padding:16px }
    .pop-title{ font-size:18px; font-weight:700; color:#2c3e50 }
    .pop-badge{ background:#ecf0f1; padding:4px 10px; border-radius:999px; font-size:12px; color:#2c3e50 }
    .pop-toggle{ width:100%; text-align:left; background:#eef3f7; border-top:1px solid #e3e8ee; padding:12px 16px; cursor:pointer; display:flex; align-items:center; justify-content:space-between }
    .pop-toggle span{ font-weight:600; color:#2c3e50 }
    .pop-toggle i{ transition:transform .2s }
    .pop-toggle.open i{ transform:rotate(180deg) }

    .switch-list{ display:none; padding:8px 16px 16px 16px; overflow:visible; position:relative }
    .switch-row{ background:#fff; border:1px solid #eee; border-radius:8px; padding:12px; display:flex; gap:12px; align-items:center; justify-content:space-between; position:relative; overflow:visible }
    .switch-info-wrap{ display:flex; flex-direction:column; gap:2px }
    .switch-name{ font-weight:700; color:#2c3e50 }
    .switch-meta{ font-size:14px; color:#7f8c8d }
    .row-actions{ display:flex; gap:8px; align-items:center }

    .hover-preview{ position:absolute; left:50%; bottom:calc(100% + 10px); transform:translate(-50%, 6px) scale(.98); width:340px; max-width:90vw; max-height:260px; background:#fff; border:1px solid #e6e9ef; border-radius:10px; box-shadow:0 10px 28px rgba(20,30,50,.18); padding:10px; opacity:0; pointer-events:none; transition:opacity .15s ease, transform .15s ease; z-index:999 }
    .switch-row:hover .hover-preview{ opacity:1; transform:translate(-50%,0) scale(1) }
    .hover-preview::before{ content:""; position:absolute; left:50%; bottom:-16px; transform:translateX(-50%); border-width:8px; border-style:solid; border-color:#e6e9ef transparent transparent transparent }
    .hover-preview::after{ content:""; position:absolute; left:50%; bottom:-15px; transform:translateX(-50%); border-width:8px; border-style:solid; border-color:#fff transparent transparent transparent }
    .hover-preview img{ width:100%; height:auto; display:block; border-radius:6px; object-fit:cover; max-height:240px }
    .hover-preview .noimg{ color:#7f8c8d; font-size:14px; text-align:center; padding:18px 6px }

    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; padding:20px; z-index:1200 }
    .modal.open{ display:flex }
    .modal-content{ background:#fff; width:min(900px, 100%); max-height:90vh; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,.25); overflow:auto }
    .modal-header{ padding:16px 20px; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between }
    .modal-title{ font-size:18px; font-weight:700 }
    .modal-body{ padding:20px }
    .modal-footer{ padding:16px 20px; border-top:1px solid #eee; display:flex; gap:10px; justify-content:flex-end }
    .close-x{ background:transparent; border:0; font-size:20px; cursor:pointer }

    .form-group{ margin-bottom:16px }
    label{ display:block; margin-bottom:8px; font-weight:600; color:#2c3e50 }
    input,select{ width:100%; padding:12px; border:1px solid #ddd; border-radius:5px; transition:border-color .3s }
    input:focus,select:focus{ border-color:#3498db; outline:0; box-shadow:0 0 0 2px rgba(52,152,219,.2) }
    .file-input-wrapper{ position:relative; overflow:hidden; display:inline-block; width:100% }
    .file-input-wrapper input[type=file]{ position:absolute; left:0; top:0; opacity:0; width:100%; height:100%; cursor:pointer }
    .file-input-button{ display:block; padding:12px; background:#ecf0f1; border:1px solid #ddd; border-radius:5px; text-align:center; cursor:pointer; transition:background .3s }
    .file-input-button:hover{ background:#d5dbdb }

    .hide{ display:none !important }

    .loading-wrap{ display:flex; flex-direction:column; align-items:center; justify-content:center; padding:28px; min-height:140px }
    .progress{ width:100%; max-width:420px; height:10px; background:#e8eef6; border-radius:999px; overflow:hidden; position:relative }
    .progress .indeterminate{ position:absolute; left:-40%; top:0; bottom:0; width:40%; background:linear-gradient(90deg,#3498db,#6fb3ff); animation:indeterminate 1.2s infinite linear }
    @keyframes indeterminate{ 0%{left:-40%; width:40%} 50%{left:30%; width:30%} 100%{left:100%; width:40%} }

    /* ====== BLOQUEIO VISUAL ====== */
    body.locked .row-actions{ display:none !important }
    body.locked #menuNovoCadastro,
    body.locked #menuGerenciarPops{ display:none !important }
    body.locked .lock-badge{ background:#2a0f12 }

    /* ====== Modal de Senha ====== */
    .password-field{ position:relative }
    .password-field input{ width:100%; padding-right:44px }
    .password-field .eye{
      position:absolute; right:8px; top:50%; transform:translateY(-50%);
      width:34px; height:34px; border:0; background:transparent; cursor:pointer;
      border-radius:8px; display:grid; place-items:center; color:#2c3e50;
    }
    .password-field .eye:hover{ background:#ecf0f1 }
    .input-hint{ color:#e74c3c; margin-top:8px; font-size:14px }

    /* ====== MINI GALERIA ====== */
    .mini-gallery{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }
    .mini-thumb{
      width:70px;
      height:50px;
      border-radius:4px;
      overflow:hidden;
      border:1px solid #ddd;
      background:#f4f4f4;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      cursor:pointer;
      transition:all .2s;
    }
    .mini-thumb:hover{
      border-color:#3498db;
      transform:scale(1.05);
    }
    .mini-thumb.selected{
      border-color:#4CAF50;
      border-width:3px;
    }
    .mini-thumb img{
      max-width:100%;
      max-height:100%;
      display:block;
      object-fit:cover;
    }
    .mini-thumb span{
      font-size:11px;
      color:#7f8c8d;
    }
    
    .existing-images-section{
      margin-top:20px;
      padding-top:20px;
      border-top:2px solid #e9ecef;
    }
    .existing-images-section h4{
      color:#2c3e50;
      margin-bottom:10px;
      font-size:14px;
      font-weight:600;
    }
    .no-images-message{
      color:#999;
      font-style:italic;
      padding:10px;
      text-align:center;
      font-size:13px;
    }
  </style>
</head>

<!-- Começa colapsado e BLOQUEADO -->
<body class="sidebar-collapsed locked">
  <!-- VIDEO OCULTO PARA FAVICON ANIMADO -->
  <video id="favVideo" width="256" height="256" preload="auto" muted playsinline loop
         autoplay crossorigin="anonymous"
         style="position:absolute; left:-9999px; width:256px; height:256px; visibility:hidden; background:transparent url('https://cdn-icons-png.flaticon.com/512/19034/19034328.png') 50% 50% / contain no-repeat;">
    <source src="https://cdn-icons-mp4.flaticon.com/512/19034/19034328.mp4" type="video/mp4">
  </video>

  <div class="sidebar-overlay" onclick="document.body.classList.remove('sidebar-open')"></div>
  <div class="edge-hitbox" id="edgeHitbox" aria-hidden="true"></div>

  <aside class="sidebar" aria-label="Menu lateral">
    <div class="brand">
      <div class="brand-left">
        <div class="logo">GR</div>
        <div class="title"><b>MENU</b></div>
      </div>
      <button class="collapse-btn" id="btnCollapse" aria-expanded="false" title="Mostrar menu">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
      </button>
    </div>

    <nav class="menu">
      <h4>Ações</h4>
      <div class="item" id="menuNovoCadastro" data-label="Novo cadastro" role="button" tabindex="0">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M5 12h14"></path></svg>
        </span>
        <span>Novo cadastro</span>
      </div>

      <div class="item" id="menuGerenciarPops" data-label="Gerenciar POPs" role="button" tabindex="0">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"></path>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.07a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.07c.18 0 .35-.04.51-.11.61-.25 1-.85 1-1.51V9c0-.66-.39-1.26-1-1.51A2 2 0 1 1 5.93 4.1l.06.06c.51.51 1.23.66 1.89.45H9c.66 0 1.24-.39 1.51-1V3a2 2 0 1 1 4 0v.07c.27.6.85.99 1.51 1h.1c.66 0 1.27-.26 1.72-.71l.06-.06A2 2 0 1 1 20.93 6.1l-.06.06c-.34.47-.49 1.06-.45 1.64V9c0 .66.39 1.26 1 1.51.16.07.33.11.51.11H21a2 2 0 1 1 0 4h-.07c-.18 0-.35.04-.51.11-.61.25-1 .85-1 1.51z"></path>
          </svg>
        </span>
        <span>Gerenciar POPs</span>
      </div>
    </nav>

    <!-- Rodapé com botão de cadeado -->
    <div class="sidebar-footer">
      <button class="lock-btn" id="lockBtn" title="Bloquear/Desbloquear">
        <img id="lockIcon" alt="cadeado" src="https://cdn-icons-png.flaticon.com/512/7615/7615902.png">
        <span id="lockText">Bloqueado</span>
        <span class="lock-badge" id="lockBadge">LOCK</span>
      </button>
    </div>
  </aside>

  <div class="with-sidebar">
    <div class="container">
      <header>
        <div class="header-row">
          <h1>Gestão de Switches de Rede</h1>
          <p class="subtitle">Todos → Switches de POPs</p>
        </div>
      </header>

      <div class="main-content">
        <section class="switches-section">
          <h2>POPs Cadastrados</h2>
          <div id="estadoContainer">
            <div id="estadoLoading" class="loading-wrap" role="status" aria-live="polite" aria-busy="true">
              <div class="progress" aria-hidden="true"><div class="indeterminate"></div></div>
              <div class="muted" style="text-align:center;margin-top:12px">Carregando…</div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <!-- Confirm/Alert modal reutilizável -->
  <div class="modal" id="confirmModal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="confirmModalTitle">
    <div class="modal-content" style="max-width:600px">
      <div class="modal-header">
        <div class="modal-title" id="confirmModalTitle">Confirmar</div>
        <button class="close-x" data-close="confirmModal" aria-label="Fechar">&times;</button>
      </div>
      <div class="modal-body">
        <p id="confirmModalMessage" style="margin:0; color:#333; line-height:1.4"></p>
      </div>
      <div class="modal-footer">
        <button class="btn ghost" id="confirmCancelBtn">Cancelar</button>
        <button class="btn danger" id="confirmOkBtn">Remover</button>
      </div>
    </div>
  </div>

  <!-- Modal de Senha -->
  <div class="modal" id="passwordModal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="passwordTitle">
    <div class="modal-content" style="max-width:420px">
      <div class="modal-header">
        <div class="modal-title" id="passwordTitle">Destravar</div>
        <button class="close-x" data-close="passwordModal" aria-label="Fechar">&times;</button>
      </div>
      <form class="modal-body" id="passwordForm">
        <label for="passwordInput" class="muted" style="display:block;margin-bottom:8px">
          Digite a senha para destravar:
        </label>
        <div class="password-field">
          <input type="password" id="passwordInput" placeholder="••••••" autocomplete="current-password" required>
          <button type="button" class="eye" id="togglePass" aria-label="Mostrar/ocultar senha" title="Mostrar/ocultar senha">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7Z"></path>
              <circle cx="12" cy="12" r="3"></circle>
            </svg>
          </button>
        </div>
        <div class="input-hint" id="passwordError" style="display:none">Senha incorreta. Tente novamente.</div>
      </form>
      <div class="modal-footer">
        <button class="btn ghost" type="button" data-close="passwordModal">Cancelar</button>
        <button class="btn" id="passwordOkBtn" form="passwordForm">OK</button>
      </div>
    </div>
  </div>

  <!-- SUGESTÕES DE MODELOS -->
  <datalist id="modelosBase">
    <option value="Datacom DM3000"></option>
    <option value="Datacom DM4100"></option>
    <option value="Datacom EDD 2104"></option>
    <option value="Cisco Catalyst 2960"></option>
    <option value="Cisco Catalyst 9200"></option>
    <option value="Huawei S5720"></option>
    <option value="HP/Aruba 2530"></option>
    <option value="MikroTik CRS326"></option>
    <option value="Juniper EX3300"></option>
    <option value="Planet GSW"></option>
  </datalist>

  <!-- MODAIS CADASTRO / EDIÇÃO / POPS -->
  <div class="modal" id="modalCadastro" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Novo cadastro</div>
        <button class="close-x" data-close="modalCadastro" aria-label="Fechar">&times;</button>
      </div>
      <div class="modal-body">
        <form id="cadastroForm">
          <div class="form-group">
            <label for="tipoCadastro">O que deseja cadastrar?</label>
            <select id="tipoCadastro" required>
              <option value="switch">Switch</option>
              <option value="pop">POP</option>
            </select>
          </div>

          <div id="camposPOP" class="hide" style="display:none">
            <div class="form-group">
              <label for="popNome">Nome/Descrição do POP</label>
              <input type="text" id="popNome" placeholder="Ex: São Paulo (POP-SP)">
            </div>
            <div class="form-group">
              <label for="popEstado">Estado (UF)</label>
              <select id="popEstado"></select>
            </div>
          </div>

          <div id="camposSW" style="display:block">
            <div class="form-group">
              <label for="pop">POP (Ponto de Presença)</label>
              <select id="pop"></select>
              <div class="muted" style="margin-top:6px">Se o POP não existir, selecione "POP" acima e cadastre.</div>
            </div>
            <div class="form-group">
              <label for="modelo">Modelo</label>
              <input type="text" id="modelo" list="modelosBase" placeholder="Ex: DM3000">
            </div>
            <div class="form-group">
              <label for="nome">Nome do Switch</label>
              <input type="text" id="nome" placeholder="Ex: SWAC01-RCE03">
            </div>
            <div class="form-group">
              <label for="ip">Endereço IP</label>
              <input type="text" id="ip" placeholder="Ex: 192.168.1.100">
            </div>
            <div class="form-group">
              <label for="foto">Foto do Switch</label>
              <div class="file-input-wrapper">
                <div class="file-input-button">Selecionar imagem</div>
                <input type="file" id="foto" accept="image/*">
              </div>
              <!-- MINI GALERIA DE FOTOS (NOVO CADASTRO) -->
              <div id="galleryCadastro" class="mini-gallery"></div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn ghost" data-close="modalCadastro">Cancelar</button>
        <button class="btn" id="btnSalvarCadastro">Cadastrar</button>
      </div>
    </div>
  </div>

  <div class="modal" id="modalEditSwitch" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Editar Switch</div>
        <button class="close-x" data-close="modalEditSwitch" aria-label="Fechar">&times;</button>
      </div>
      <div class="modal-body">
        <form id="formEditSwitch">
          <input type="hidden" id="editSwitchId">
          <div class="form-group">
            <label for="editSwitchNome">Nome do Switch</label>
            <input type="text" id="editSwitchNome">
          </div>
          <div class="form-group">
            <label for="editSwitchIP">Endereço IP</label>
            <input type="text" id="editSwitchIP" placeholder="Ex: 192.168.1.100">
          </div>
          <div class="form-group">
            <label for="editSwitchModelo">Modelo</label>
            <input type="text" id="editSwitchModelo" list="modelosBase" placeholder="Ex: DM4100">
          </div>
          <div class="form-group">
            <label for="editSwitchPop">POP</label>
            <select id="editSwitchPop"></select>
          </div>
          <div class="form-group">
            <label for="editSwitchFoto">Foto do Switch</label>
            <div class="row-actions">
              <div class="file-input-wrapper" style="flex:1">
                <div class="file-input-button">Selecionar imagem</div>
                <input type="file" id="editSwitchFoto" accept="image/*">
              </div>
              <button type="button" class="btn ghost small" id="btnRemoverFoto">Remover imagem</button>
            </div>
            <div class="muted" id="previewInfo" style="margin-top:8px"></div>
            <!-- MINI GALERIA DE FOTOS (EDIÇÃO) -->
            <div id="galleryEdit" class="mini-gallery"></div>
          </div>
          <!-- NOVA SEÇÃO: IMAGENS EXISTENTES DE OUTROS SWITCHES -->
          <div class="existing-images-section">
            <h4>Imagens de Outros Switches:</h4>
            <div id="galleryExistingImages" class="mini-gallery"></div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn ghost" data-close="modalEditSwitch">Cancelar</button>
        <button class="btn" id="btnSalvarEditSwitch">Salvar</button>
      </div>
    </div>
  </div>

  <div class="modal" id="modalPops" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Gerenciar POPs</div>
        <button class="close-x" data-close="modalPops" aria-label="Fechar">&times;</button>
      </div>
      <div class="modal-body">
        <div class="muted" style="margin-bottom:10px">Renomeie, ajuste o Estado (UF) ou exclua POPs. Ao renomear, o sistema atualiza o <em>slug</em>/id e realoca os Switches automaticamente.</div>
        <table id="tabelaPops">
          <thead>
            <tr>
              <th style="width:34%">Nome/Descrição</th>
              <th style="width:18%">Estado (UF)</th>
              <th style="width:24%">ID (slug)</th>
              <th>Switches</th>
              <th style="width:200px">Ações</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button class="btn ghost" data-close="modalPops">Fechar</button>
        <button class="btn" id="btnSalvarPops">Salvar Alterações</button>
      </div>
    </div>
  </div>

  <script type="module">
    /* ========= Firebase ========= */
    const firebaseConfig = {
      apiKey: "AIzaSyCGSDjIf8pRP_IE0xqjLii4Qeuc6_bhE50",
      authDomain: "gestao-switches.firebaseapp.com",
      databaseURL: "https://gestao-switches-default-rtdb.firebaseio.com",
      projectId: "gestao-switches",
      storageBucket: "gestao-switches.firebasestorage.app",
      messagingSenderId: "499639422553",
      appId: "1:499639422553:web:b2964704013a95ee666b48",
      measurementId: "G-EVK2QKJL4Y"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    const fbApp = initializeApp(firebaseConfig);
    const fbAuth = getAuth(fbApp);
    const fbDb = getDatabase(fbApp);

    signInAnonymously(fbAuth).catch(err => console.warn('[FB] Erro ao autenticar anon:', err));
    onAuthStateChanged(fbAuth, user => { if (user) { loadPops(); loadSwitches(); } });

    /* ========= Estado / Utils ========= */
    const LS_SIDEBAR_STATE = 'sidebarCollapsed';
    const byId = (id) => document.getElementById(id);
    const isMobile = () => window.matchMedia('(max-width: 900px)').matches;

    function validarIP(ip){
      const re=/^(25[0-5]|2[0-4]\d|[01]?\d?\d)(\.(25[0-5]|2[0-4]\d|[01]?\d?\d)){3}$/;
      return re.test(ip);
    }
    const slugify=(s)=>s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');

    const estados=['AC','AL','AP','AM','BA','CE','DF','ES','GO','MA','MT','MS','MG','PA','PB','PR','PE','PI','RJ','RN','RS','RO','RR','SC','SP','SE','TO'];
    const estadoLabel=(uf)=> uf && uf!=='__' ? uf : 'Sem Estado';

    const POPS_PADRAO=[
      { nome:'São Paulo (POP-SP)', uf:'SP' },
      { nome:'Rio de Janeiro (POP-RJ)', uf:'RJ' },
      { nome:'Belo Horizonte (POP-MG)', uf:'MG' },
      { nome:'Porto Alegre (POP-RS)', uf:'RS' },
      { nome:'Curitiba (POP-PR)', uf:'PR' },
      { nome:'Salvador (POP-BA)', uf:'BA' },
      { nome:'Fortaleza (POP-CE)', uf:'CE' },
      { nome:'Brasília (POP-DF)', uf:'DF' }
    ].map(n => ({ id: slugify(n.nome), nome:n.nome, estado:n.uf }));

    /* ===== Helpers de imagem (compactado) ===== */
    async function compressImage(file,{maxWidth=1600,maxHeight=1200,mimeType='image/webp',quality=.82}={}){
      if(!('createImageBitmap' in window)) return await fileToDataURL(file);
      const bitmap=await createImageBitmap(file);
      const {width,height}=bitmap; const ratio=Math.min(maxWidth/width,maxHeight/height,1);
      const canvas=document.createElement('canvas'); canvas.width=Math.round(width*ratio); canvas.height=Math.round(height*ratio);
      const ctx=canvas.getContext('2d'); ctx.imageSmoothingEnabled=true; ctx.imageSmoothingQuality='high';
      ctx.drawImage(bitmap,0,0,canvas.width,canvas.height);
      let outType=mimeType; if(!canvas.toDataURL(outType).startsWith('data:image/webp')) outType='image/jpeg';
      return canvas.toDataURL(outType,quality);
    }
    function fileToDataURL(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=e=>res(e.target.result); fr.onerror=rej; fr.readAsDataURL(file); }); }
    async function compressAdaptively(file){
      const steps=[{w:2200,h:1600,q:.88},{w:1800,h:1350,q:.84},{w:1600,h:1200,q:.82},{w:1400,h:1050,q:.78},{w:1200,h:900,q:.75},{w:1000,h:750,q:.72},{w:900,h:675,q:.7}];
      for(const s of steps){ const d=await compressImage(file,{maxWidth:s.w,maxHeight:s.h,quality:s.q}); if(d.length<4_500_000) return d; }
      return await compressImage(file,{maxWidth:800,maxHeight:600,quality:.68});
    }

    /* ===== POPs/Switches ===== */
    let switches=[]; let pops=[]; let pendingPopEdits=[];
    let popsLoaded=false; let switchesLoaded=false; let loadFallbackTimer=null;
    let selectedExistingImage=null; // NOVA VARIÁVEL PARA ARMAZENAR IMAGEM SELECIONADA

    function loadPops(){
      const dbRef=ref(fbDb,'pops');
      onValue(dbRef,(snap)=>{
        const data=snap.val(); pops=data?Object.values(data):[];
        if(!pops || pops.length===0){ pops=[...POPS_PADRAO]; savePops(); }
        renderPopOptions(); popsLoaded=true; renderWhenReady();
      },(err)=>{ console.error('Erro POPs',err); popsLoaded=true; renderWhenReady(); });
    }
    function savePops(){ const dbRef=ref(fbDb,'pops'); const obj={}; pops.forEach(p=>obj[p.id]=p); set(dbRef,obj).catch(()=> showAlert({title:'Erro',message:'Falha ao salvar POPs.'})); }
    function loadSwitches(){
      const dbRef=ref(fbDb,'switches');
      onValue(dbRef,(snap)=>{ const data=snap.val(); switches=data?Object.values(data):[]; switchesLoaded=true; renderWhenReady(); },
                    (err)=>{ console.error('Erro switches',err); switchesLoaded=true; renderWhenReady(); });
    }
    function saveSwitches(){ const dbRef=ref(fbDb,'switches'); const obj={}; switches.forEach(s=>obj[s.id]=s); set(dbRef,obj).catch(()=> showAlert({title:'Erro',message:'Falha ao salvar switches.'})); }

    /* ========= Confirm/Alert ========= */
    function _openModalById(id){ const el=byId(id); if(!el) return; el.classList.add('open'); el.setAttribute('aria-hidden','false'); }
    function _closeModalById(id){ const el=byId(id); if(!el) return; el.classList.remove('open'); el.setAttribute('aria-hidden','true'); }

    function showConfirm({ title='Confirmar', message='', okLabel='Confirmar', cancelLabel='Cancelar', okIsDanger=false }={}){
      return new Promise(resolve=>{
        const modal=byId('confirmModal'); if(!modal){ resolve(window.confirm(message)); return; }
        const originalParent=modal.parentElement, originalNext=modal.nextSibling;
        document.body.appendChild(modal); const originalZ=modal.style.zIndex||''; modal.style.zIndex='3000';

        const titleEl=modal.querySelector('#confirmModalTitle');
        const msgEl=modal.querySelector('#confirmModalMessage');
        const okBtn=modal.querySelector('#confirmOkBtn');
        const cancelBtn=modal.querySelector('#confirmCancelBtn');
        const closeBtn=modal.querySelector('.close-x');

        titleEl.textContent=title; msgEl.textContent=message;
        okBtn.textContent=okLabel; cancelBtn.textContent=cancelLabel;
        cancelBtn.style.display=''; okBtn.classList.toggle('danger',!!okIsDanger);

        const onOk=()=>{ cleanup(); resolve(true) };
        const onCancel=()=>{ cleanup(); resolve(false) };
        const onClose=()=>{ onCancel() };

        function restore(){ try{ if(originalParent){ if(originalNext) originalParent.insertBefore(modal,originalNext); else originalParent.appendChild(modal);} }catch{} finally{ modal.style.zIndex=originalZ; } }
        function cleanup(){ okBtn.removeEventListener('click',onOk); cancelBtn.removeEventListener('click',onCancel); if(closeBtn) closeBtn.removeEventListener('click',onClose); okBtn.classList.remove('danger'); _closeModalById('confirmModal'); restore(); }

        okBtn.addEventListener('click',onOk); cancelBtn.addEventListener('click',onCancel); if(closeBtn) closeBtn.addEventListener('click',onClose);
        _openModalById('confirmModal');
      });
    }

    function showAlert({ title='Aviso', message='Operação concluída.' }={}){
      return new Promise(resolve=>{
        const modal=byId('confirmModal'); if(!modal){ window.alert(message); resolve(); return; }
        const originalParent=modal.parentElement, originalNext=modal.nextSibling;
        document.body.appendChild(modal); const originalZ=modal.style.zIndex||''; modal.style.zIndex='3000';

        const titleEl=modal.querySelector('#confirmModalTitle');
        const msgEl=modal.querySelector('#confirmModalMessage');
        const okBtn=modal.querySelector('#confirmOkBtn');
        const cancelBtn=modal.querySelector('#confirmCancelBtn');
        const closeBtn=modal.querySelector('.close-x');

        titleEl.textContent=title; msgEl.textContent=message;
        okBtn.textContent='OK'; cancelBtn.style.display='none'; okBtn.classList.remove('danger');

        const onOk=()=>{ cleanup(); resolve(); };
        const onClose=()=>{ cleanup(); resolve(); };

        function restore(){ try{ if(originalParent){ if(originalNext) originalParent.insertBefore(modal,originalNext); else originalParent.appendChild(modal);} }catch{} finally{ modal.style.zIndex=originalZ; } }
        function cleanup(){ okBtn.removeEventListener('click',onOk); if(closeBtn) closeBtn.removeEventListener('click',onClose); cancelBtn.style.display=''; _closeModalById('confirmModal'); restore(); }

        okBtn.addEventListener('click',onOk); if(closeBtn) closeBtn.addEventListener('click',onClose);
        _openModalById('confirmModal');
      });
    }

    /* ========= Loading / Render control ========= */
    function showLoading(show){ const loading=byId('estadoLoading'); const container=byId('estadoContainer'); if(!loading||!container) return; loading.style.display=show?'flex':'none'; }
    function renderWhenReady(){ if(popsLoaded && switchesLoaded){ clearTimeout(loadFallbackTimer); showLoading(false); renderEstadosComPops(); } }
    function startLoadFallbackTimer(ms=8000){
      clearTimeout(loadFallbackTimer);
      loadFallbackTimer=setTimeout(()=>{
        if(!(popsLoaded && switchesLoaded)){
          showLoading(false);
          const wrap=byId('estadoContainer');
          if(wrap) wrap.innerHTML='<div class="no-pops">Não foi possível carregar os POPs. Verifique sua conexão ou tente novamente. Use "Novo cadastro".</div>';
        }
      },ms);
    }

    /* ========= Render ========= */
    function popsByEstado(){ const groups={}; pops.forEach(p=>{ const uf=p.estado||'__'; (groups[uf]??=[]).push(p); }); Object.keys(groups).forEach(uf=> groups[uf].sort((a,b)=> a.nome.localeCompare(b.nome,'pt-BR'))); return groups; }
    function renderEstadosComPops(){
      const wrap=byId('estadoContainer'); if(!wrap) return;
      if(!pops || pops.length===0){ wrap.innerHTML='<div class="no-pops">Nenhum POP cadastrado ainda. Use "Novo cadastro".</div>'; return; }
      const groups=popsByEstado();
      const ufs=Object.keys(groups).sort((a,b)=>{ if(a==='__') return 1; if(b==='__') return -1; return a.localeCompare(b); });
      wrap.innerHTML='';
      ufs.forEach(uf=>{
        const bloco=document.createElement('div'); bloco.className='estado-block';
        const totalSwitchesUF=groups[uf].reduce((acc,p)=> acc + switches.filter(s=>s.pop===p.id).length,0);
        bloco.innerHTML=`
          <div class="estado-head">
            <div class="h3">${estadoLabel(uf)}</div>
            <div class="estado-badge">${groups[uf].length} POP${groups[uf].length===1?'':'s'} • ${totalSwitchesUF} switch${totalSwitchesUF===1?'':'es'}</div>
          </div>
          <div class="pop-grid"></div>
        `;
        const grid=bloco.querySelector('.pop-grid');

        groups[uf].forEach(pop=>{
          const card=document.createElement('div'); card.className='pop-card';
          const swDoPop=switches.filter(s=>s.pop===pop.id);
          card.innerHTML=`
            <div class="pop-header">
              <div class="pop-title">${pop.nome}</div>
              <div class="pop-badge">${swDoPop.length} switch${swDoPop.length===1?'':'es'}</div>
            </div>
            <button class="pop-toggle" data-toggle-pop="${pop.id}" aria-expanded="false">
              <span>Ver switches</span><i>▼</i>
            </button>
            <div class="switch-list">
              ${
                swDoPop.length===0
                ? `<div class="no-switches" style="padding:16px">Nenhum switch vinculado a este POP.</div>`
                : swDoPop.map(sw=>`
                    <div class="switch-row" data-switch-id="${sw.id}">
                      <div class="switch-info-wrap">
                        <div class="switch-name">${sw.nome}</div>
                        <div class="switch-meta">IP: ${sw.ip}</div>
                        <div class="switch-meta">Modelo: ${sw.modelo ? sw.modelo : '—'}</div>
                      </div>
                      <div class="row-actions">
                        <button class="btn small" data-action="edit">Editar</button>
                        <button class="btn danger small" data-action="delete">Excluir</button>
                      </div>
                      <div class="hover-preview">
                        ${ sw.foto ? `<img src="${sw.foto}" alt="Foto de ${sw.nome}">` : `<div class="noimg">Sem imagem para este switch</div>` }
                      </div>
                    </div>
                  `).join('')
              }
            </div>`;
          grid.appendChild(card);
        });

        wrap.appendChild(bloco);
      });
    }
    function renderUFSelect(selectEl){ if(!selectEl) return; selectEl.innerHTML=`<option value="__">Sem Estado</option>`+estados.map(uf=>`<option value="${uf}">${uf}</option>`).join(''); }
    function renderPopOptions(){
      const sel=byId('pop'); if(!sel) return;
      if(!pops || pops.length===0){ sel.innerHTML='<option value="">Cadastre um POP</option>'; return; }
      const groups=popsByEstado(); const ufs=Object.keys(groups).sort((a,b)=>{ if(a==='__') return 1; if(b==='__') return -1; return a.localeCompare(b); });
      sel.innerHTML=ufs.map(uf=>{ const options=groups[uf].map(p=>`<option value="${p.id}">${p.nome}</option>`).join(''); return `<optgroup label="${estadoLabel(uf)}">${options}</optgroup>`; }).join('');
    }

    /* ========= CRUD ========= */
    function openModal(id){ const el=byId(id); if(el){ el.classList.add('open'); el.setAttribute('aria-hidden','false'); } }
    function closeModal(id){ const el=byId(id); if(el){ el.classList.remove('open'); el.setAttribute('aria-hidden','true'); } }

    function openEditSwitch(swId){
      const sw=switches.find(s=>s.id===swId); if(!sw) return;
      byId('editSwitchId').value=sw.id;
      byId('editSwitchNome').value=sw.nome||'';
      byId('editSwitchIP').value=sw.ip||'';
      byId('editSwitchModelo').value=sw.modelo||'';

      const selPop=byId('editSwitchPop');
      if(selPop){
        selPop.innerHTML='';
        const groups=popsByEstado();
        const ufs=Object.keys(groups).sort((a,b)=>{ if(a==='__') return 1; if(b==='__') return -1; return a.localeCompare(b); });
        ufs.forEach(uf=>{
          const optgroup=document.createElement('optgroup'); optgroup.label=estadoLabel(uf);
          groups[uf].forEach(p=>{
            const opt=document.createElement('option'); opt.value=p.id; opt.textContent=p.nome;
            if(p.id===sw.pop) opt.selected=true;
            optgroup.appendChild(opt);
          });
          selPop.appendChild(optgroup);
        });
      }

      const galleryEdit=byId('galleryEdit');
      if(galleryEdit){
        galleryEdit.innerHTML='';
        if(sw.foto){
          const thumb=document.createElement('div'); thumb.className='mini-thumb';
          const img=document.createElement('img'); img.src=sw.foto; img.alt='Foto atual';
          thumb.appendChild(img);
          galleryEdit.appendChild(thumb);
        } else {
          galleryEdit.innerHTML='<span style="color:#7f8c8d;font-size:12px">Nenhuma foto cadastrada</span>';
        }
      }

      // NOVA FUNCIONALIDADE: Populate existing images from other switches
      const galleryExisting=byId('galleryExistingImages');
      if(galleryExisting){
        galleryExisting.innerHTML='';
        selectedExistingImage=null; // Reset selection
        
        const otherSwitchesWithPhotos=switches.filter((s,i)=> s.id!==sw.id && s.foto);
        
        if(otherSwitchesWithPhotos.length>0){
          otherSwitchesWithPhotos.forEach((s,i)=>{
            const thumb=document.createElement('div');
            thumb.className='mini-thumb';
            thumb.dataset.photoData=s.foto;
            thumb.title=`Foto de ${s.nome}`;
            
            const img=document.createElement('img');
            img.src=s.foto;
            img.alt=`Foto de ${s.nome}`;
            
            thumb.appendChild(img);
            
            // Add click event to select image
            thumb.addEventListener('click',function(){
              // Remove selection from all images
              galleryExisting.querySelectorAll('.mini-thumb').forEach(t=>t.classList.remove('selected'));
              // Select this image
              this.classList.add('selected');
              selectedExistingImage=this.dataset.photoData;
            });
            
            galleryExisting.appendChild(thumb);
          });
        } else {
          galleryExisting.innerHTML='<p class="no-images-message">Nenhuma imagem de outros switches.</p>';
        }
      }

      openModal('modalEditSwitch');
    }

    byId('btnSalvarEditSwitch')?.addEventListener('click',async()=>{
      const swId=byId('editSwitchId').value;
      const sw=switches.find(s=>s.id===swId); if(!sw) return;

      const nome=byId('editSwitchNome').value.trim();
      const ip=byId('editSwitchIP').value.trim();
      const modelo=byId('editSwitchModelo').value.trim();
      const popId=byId('editSwitchPop').value;

      if(!nome||!ip){ await showAlert({title:'Erro',message:'Nome e IP são obrigatórios.'}); return; }
      if(!validarIP(ip)){ await showAlert({title:'Erro',message:'IP inválido.'}); return; }

      const photoFile=byId('editSwitchFoto').files[0];
      let photoData=sw.foto;

      // Priority: new upload > selected existing image > keep current
      if(photoFile){
        photoData=await compressAdaptively(photoFile);
      } else if(selectedExistingImage){
        photoData=selectedExistingImage;
      }

      sw.nome=nome; sw.ip=ip; sw.modelo=modelo; sw.pop=popId; sw.foto=photoData;
      saveSwitches(); renderEstadosComPops(); closeModal('modalEditSwitch');
      await showAlert({title:'Sucesso',message:'Switch atualizado com sucesso!'});
    });

    /* ========= Event Delegation ========= */
    document.addEventListener('click',e=>{
      const t=e.target;
      if(t.matches('[data-close]')){ const id=t.getAttribute('data-close'); closeModal(id); }
      if(t.matches('[data-toggle-pop]')){
        const popId=t.getAttribute('data-toggle-pop');
        const list=t.nextElementSibling;
        if(list && list.classList.contains('switch-list')){
          const isOpen=list.style.display==='block';
          list.style.display=isOpen?'none':'block';
          t.classList.toggle('open',!isOpen);
          t.setAttribute('aria-expanded',!isOpen);
        }
      }
      if(t.matches('[data-action="edit"]')){
        const row=t.closest('.switch-row');
        if(row){ const swId=row.getAttribute('data-switch-id'); openEditSwitch(swId); }
      }
      if(t.matches('[data-action="delete"]')){
        const row=t.closest('.switch-row');
        if(row){
          const swId=row.getAttribute('data-switch-id');
          const sw=switches.find(s=>s.id===swId);
          if(sw){
            showConfirm({title:'Confirmar exclusão',message:`Deseja realmente excluir o switch "${sw.nome}"?`,okLabel:'Excluir',okIsDanger:true})
            .then(ok=>{ if(ok){ switches=switches.filter(s=>s.id!==swId); saveSwitches(); renderEstadosComPops(); } });
          }
        }
      }
    });

    /* ========= Sidebar ========= */
    const btnCollapse=byId('btnCollapse');
    const edgeHitbox=byId('edgeHitbox');
    function toggleSidebar(){ document.body.classList.toggle('sidebar-collapsed'); const collapsed=document.body.classList.contains('sidebar-collapsed'); localStorage.setItem(LS_SIDEBAR_STATE,collapsed?'1':'0'); btnCollapse?.setAttribute('aria-expanded',collapsed?'false':'true'); btnCollapse?.setAttribute('title',collapsed?'Mostrar menu':'Ocultar menu'); }
    btnCollapse?.addEventListener('click',toggleSidebar);
    edgeHitbox?.addEventListener('mouseenter',()=>{ if(isMobile()) document.body.classList.add('sidebar-open'); });

    /* ========= Lock/Unlock ========= */
    const SENHA_CORRETA='1234';
    const lockBtn=byId('lockBtn'); const lockIcon=byId('lockIcon'); const lockText=byId('lockText'); const lockBadge=byId('lockBadge');
    function isLocked(){ return document.body.classList.contains('locked'); }
    function lock(){ document.body.classList.add('locked'); if(lockIcon) lockIcon.src='https://cdn-icons-png.flaticon.com/512/7615/7615902.png'; if(lockText) lockText.textContent='Bloqueado'; if(lockBadge) lockBadge.textContent='LOCK'; }
    function unlock(){ document.body.classList.remove('locked'); if(lockIcon) lockIcon.src='https://cdn-icons-png.flaticon.com/512/3064/3064155.png'; if(lockText) lockText.textContent='Desbloqueado'; if(lockBadge) lockBadge.textContent='OPEN'; }
    lockBtn?.addEventListener('click',()=>{ if(isLocked()){ openModal('passwordModal'); byId('passwordInput').value=''; byId('passwordError').style.display='none'; } else { lock(); } });
    byId('passwordForm')?.addEventListener('submit',e=>{ e.preventDefault(); const val=byId('passwordInput').value; if(val===SENHA_CORRETA){ unlock(); closeModal('passwordModal'); } else { byId('passwordError').style.display='block'; } });
    byId('togglePass')?.addEventListener('click',()=>{ const inp=byId('passwordInput'); inp.type=inp.type==='password'?'text':'password'; });

    /* ========= Menu Items ========= */
    byId('menuNovoCadastro')?.addEventListener('click',()=>{ openModal('modalCadastro'); byId('tipoCadastro').value='switch'; byId('camposSW').style.display='block'; byId('camposPOP').style.display='none'; });
    byId('menuGerenciarPops')?.addEventListener('click',()=>{ openModal('modalPops'); renderTabelaPops(); });

    byId('tipoCadastro')?.addEventListener('change',e=>{ const val=e.target.value; byId('camposSW').style.display=val==='switch'?'block':'none'; byId('camposPOP').style.display=val==='pop'?'block':'none'; });

    byId('btnSalvarCadastro')?.addEventListener('click',async()=>{
      const tipo=byId('tipoCadastro').value;
      if(tipo==='pop'){
        const nome=byId('popNome').value.trim(); const uf=byId('popEstado').value;
        if(!nome){ await showAlert({title:'Erro',message:'Nome do POP é obrigatório.'}); return; }
        const id=slugify(nome); if(pops.find(p=>p.id===id)){ await showAlert({title:'Erro',message:'Já existe um POP com este nome.'}); return; }
        pops.push({id,nome,estado:uf}); savePops(); renderPopOptions(); renderEstadosComPops(); closeModal('modalCadastro');
        await showAlert({title:'Sucesso',message:'POP cadastrado com sucesso!'});
      } else {
        const nome=byId('nome').value.trim(); const ip=byId('ip').value.trim(); const modelo=byId('modelo').value.trim(); const popId=byId('pop').value;
        if(!nome||!ip){ await showAlert({title:'Erro',message:'Nome e IP são obrigatórios.'}); return; }
        if(!validarIP(ip)){ await showAlert({title:'Erro',message:'IP inválido.'}); return; }
        const photoFile=byId('foto').files[0]; let photoData=null;
        if(photoFile) photoData=await compressAdaptively(photoFile);
        const id=slugify(nome+'-'+Date.now()); switches.push({id,nome,ip,modelo,pop:popId,foto:photoData}); saveSwitches(); renderEstadosComPops(); closeModal('modalCadastro');
        await showAlert({title:'Sucesso',message:'Switch cadastrado com sucesso!'});
      }
    });

    byId('btnRemoverFoto')?.addEventListener('click',()=>{ const swId=byId('editSwitchId').value; const sw=switches.find(s=>s.id===swId); if(sw){ sw.foto=null; byId('galleryEdit').innerHTML='<span style="color:#7f8c8d;font-size:12px">Nenhuma foto cadastrada</span>'; } });

    function renderTabelaPops(){
      const tbody=byId('tabelaPops')?.querySelector('tbody'); if(!tbody) return;
      tbody.innerHTML='';
      pops.forEach(p=>{
        const swCount=switches.filter(s=>s.pop===p.id).length;
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td><input type="text" value="${p.nome}" data-pop-id="${p.id}" data-field="nome" style="width:100%;padding:6px;border:1px solid #ddd;border-radius:4px"></td>
          <td><select data-pop-id="${p.id}" data-field="estado" style="width:100%;padding:6px;border:1px solid #ddd;border-radius:4px">${`<option value="__">Sem Estado</option>`+estados.map(uf=>`<option value="${uf}" ${p.estado===uf?'selected':''}>${uf}</option>`).join('')}</select></td>
          <td style="color:#7f8c8d;font-size:13px">${p.id}</td>
          <td style="text-align:center">${swCount}</td>
          <td><button class="btn danger small" data-delete-pop="${p.id}">Excluir</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    byId('tabelaPops')?.addEventListener('click',e=>{
      if(e.target.matches('[data-delete-pop]')){
        const popId=e.target.getAttribute('data-delete-pop');
        const pop=pops.find(p=>p.id===popId); if(!pop) return;
        const swCount=switches.filter(s=>s.pop===popId).length;
        if(swCount>0){ showAlert({title:'Erro',message:`Não é possível excluir o POP "${pop.nome}" pois ele possui ${swCount} switch(es) vinculado(s).`}); return; }
        showConfirm({title:'Confirmar exclusão',message:`Deseja realmente excluir o POP "${pop.nome}"?`,okLabel:'Excluir',okIsDanger:true})
        .then(ok=>{ if(ok){ pops=pops.filter(p=>p.id!==popId); savePops(); renderTabelaPops(); renderPopOptions(); renderEstadosComPops(); } });
      }
    });

    byId('btnSalvarPops')?.addEventListener('click',()=>{
      const inputs=byId('tabelaPops')?.querySelectorAll('[data-pop-id]');
      inputs?.forEach(inp=>{
        const popId=inp.getAttribute('data-pop-id'); const field=inp.getAttribute('data-field'); const val=inp.value.trim();
        const pop=pops.find(p=>p.id===popId); if(!pop) return;
        if(field==='nome' && val!==pop.nome){
          const newId=slugify(val); pop.nome=val;
          switches.filter(s=>s.pop===pop.id).forEach(s=>s.pop=newId);
          pop.id=newId;
        } else if(field==='estado'){ pop.estado=val; }
      });
      savePops(); saveSwitches(); renderTabelaPops(); renderPopOptions(); renderEstadosComPops();
      showAlert({title:'Sucesso',message:'Alterações salvas com sucesso!'});
    });

    /* ========= Favicon Animado ========= */
    const favVideo=byId('favVideo'); const favLink=byId('dynamic-favicon');
    if(favVideo && favLink){
      favVideo.addEventListener('loadeddata',()=>{
        const canvas=document.createElement('canvas'); canvas.width=256; canvas.height=256; const ctx=canvas.getContext('2d');
        function updateFavicon(){ ctx.clearRect(0,0,256,256); ctx.drawImage(favVideo,0,0,256,256); favLink.href=canvas.toDataURL('image/png'); }
        favVideo.addEventListener('play',()=>{ const interval=setInterval(()=>{ if(favVideo.paused||favVideo.ended) clearInterval(interval); else updateFavicon(); },100); });
        favVideo.play().catch(()=>{});
      });
    }

    /* ========= Init ========= */
    renderUFSelect(byId('popEstado'));
    const savedCollapsed=localStorage.getItem(LS_SIDEBAR_STATE);
    if(savedCollapsed==='0'){ document.body.classList.remove('sidebar-collapsed'); btnCollapse?.setAttribute('aria-expanded','true'); btnCollapse?.setAttribute('title','Ocultar menu'); }
    document.documentElement.classList.add('js-ready');
    startLoadFallbackTimer();
  </script>
</body>
</html>
